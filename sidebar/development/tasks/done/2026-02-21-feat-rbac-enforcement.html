<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">RBAC enforcement with fine-grained permissions | OSAPI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://osapi-io.github.io/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RBAC enforcement with fine-grained permissions | OSAPI"><meta data-rh="true" name="description" content="Objective"><meta data-rh="true" property="og:description" content="Objective"><link data-rh="true" rel="icon" href="/osapi/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://osapi-io.github.io/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement"><link data-rh="true" rel="alternate" href="https://osapi-io.github.io/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement" hreflang="en"><link data-rh="true" rel="alternate" href="https://osapi-io.github.io/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement" hreflang="x-default"><link rel="stylesheet" href="/osapi/assets/css/styles.56a51dbd.css">
<script src="/osapi/assets/js/runtime~main.a378fbfc.js" defer="defer"></script>
<script src="/osapi/assets/js/main.77955af4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/osapi/"><div class="navbar__logo"><img src="/osapi/img/logo.png" alt="OSAPI Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/osapi/img/logo.png" alt="OSAPI Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OSAPI</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/osapi/">Getting Started</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Features</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/node-management">Node Management</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/network-management">Network Management</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/job-system">Job System</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/audit-logging">Audit Logging</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/command-execution">Command Execution</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/health-checks">Health Checks</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/authentication">Authentication &amp; RBAC</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/distributed-tracing">Distributed Tracing</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/osapi/sidebar/features/metrics">Metrics</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/osapi/sidebar/usage">Usage</a><a class="navbar__item navbar__link" href="/osapi/category/api">API</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement">Next</a><a href="https://github.com/retr0h/osapi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/osapi/">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/sidebar/usage">Usage</a><button aria-label="Expand sidebar category &#x27;Usage&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/category/features">Features</a><button aria-label="Expand sidebar category &#x27;Features&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/sidebar/architecture">Architecture</a><button aria-label="Expand sidebar category &#x27;Architecture&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/osapi/sidebar/development">Development</a><button aria-label="Collapse sidebar category &#x27;Development&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/testing">Testing</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/osapi/sidebar/development/tasks">Tasks</a><button aria-label="Collapse sidebar category &#x27;Tasks&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/osapi/category/done">Done</a><button aria-label="Collapse sidebar category &#x27;Done&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-chore-delete-legacy-task">Delete legacy task system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-docs-cli-doc-consistency">Audit and standardize CLI documentation formatting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-docs-feature-roadmap">Document feature roadmap with tiered priorities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-docs-rest-nats-vs-grpc-analysis">Architecture analysis — REST+NATS vs gRPC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-docs-update-docusaurus">Update Docusaurus docs for job system migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-feat-audit-logging">Audit logging for API operations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-feat-command-execution">Ad-hoc command execution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-feat-health-endpoint">Health check and readiness endpoints</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-feat-job-api-domain">Create job API domain (replace task API)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-fix-api-endpoint-validation-audit">Audit and ensure validation on all API endpoints</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-refactor-network-api-strict-server">Port network API to strict-server + job client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-refactor-operation-naming">Fix operation naming inconsistencies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-refactor-server-lifecycle-consistency">Standardize server/worker CLI lifecycle and context handling</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-refactor-system-api-job-client">Port system API to use job client</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-test-consistency-audit">Consistency pass and test coverage audit</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-15-test-verify-multi-system-routing">Verify multi-system routing and per-system response aggregation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-16-feat-broadcast-response-collection">Implement broadcast (_all) response collection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-16-feat-darwin-providers">Add Darwin development providers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-chore-evaluate-orbit-go">Evaluate synadia-io/orbit.go for NATS integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-docs-add-ai-policy">Add AI policy to the project</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-feat-api-list-nats-workers">API endpoint to list registered NATS workers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-feat-cli-consistent-host-targeting">Add consistent host targeting to all CLI commands</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-feat-label-based-worker-routing">Label-based worker routing with NATS subject wildcards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-fix-api-input-validation-hardening">Complete API input validation hardening</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-refactor-migrate-client-job-to-rest-api">Migrate client job commands from direct NATS to REST API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-refactor-rename-util-validate">Rename cmd/util_*.go files to descriptive names</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-test-coverage-100-percent">Achieve 100% test coverage on non-generated packages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-17-test-mock-audit-cleanup">Audit and clean up mocks repo-wide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-18-docs-cli-docs-audit">Audit CLI commands and docs for consistency</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-18-docs-configuration-reference">Add configuration reference documentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-18-fix-dotted-hostname-routing">Fix dotted hostname breaks NATS subject routing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-19-feat-consistent-debug-logging">Consistent debug logging across all components</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-19-feat-health-status">Rename health detailed to health status and enrich with system metrics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-19-feat-job-retry-command">Add job retry command</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-19-fix-job-list-pagination">Add server-side pagination to job list</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-19-quick-wins-job-id-tracing">Surface job IDs in API responses and CLI output</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing">Distributed tracing with OpenTelemetry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint">HTTP metrics with Prometheus endpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces">Add NATS authentication and namespace support to config</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-20-refactor-nats-config">Refactor NATS config so each consumer owns its connection settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-docs-features-section">Add Features documentation section</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-audit-log-export-backends">Support audit log export to alternative backends</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-rbac-enforcement">RBAC enforcement with fine-grained permissions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-show-worker-labels">Show worker labels in system hostname output</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-fix-broadcast-silent-failures">Surface failed worker responses in broadcast query results</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-21-fix-trace-propagation">Fix trace context propagation from API server to worker via NATS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-22-feat-client-sdk">Client SDK for programmatic automation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-25-add-changed-field-to-mutation-responses">Add `changed` field to mutation responses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-26-cli-taxonomy-reorganization">CLI taxonomy reorganization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-26-feat-health-status-enhancements">Enhance health status with agents and consumers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-5 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/tasks/done/2026-02-26-refactor-compact-table-output">Replace box-drawing tables with compact kubectl-style columns</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/category/backlog">Backlog</a><button aria-label="Expand sidebar category &#x27;Backlog&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/category/sessions">Sessions</a><button aria-label="Expand sidebar category &#x27;Sessions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development/roadmap">Roadmap</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/osapi/category/api">API</a><button aria-label="Expand sidebar category &#x27;API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/osapi/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting Started</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/osapi/sidebar/development"><span itemprop="name">Development</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/osapi/sidebar/development/tasks"><span itemprop="name">Tasks</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/osapi/category/done"><span itemprop="name">Done</span></a><meta itemprop="position" content="4"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RBAC enforcement with fine-grained permissions</span><meta itemprop="position" content="5"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RBAC enforcement with fine-grained permissions</h1></header><div class="row"><div class="col col--12 markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="objective">Objective<a href="#objective" class="hash-link" aria-label="Direct link to Objective" title="Direct link to Objective">​</a></h2>
<p>Today OSAPI has three flat roles (<code>read</code>, <code>write</code>, <code>admin</code>) with a simple
hierarchy baked into <code>authtoken.RoleHierarchy</code>. Scopes are declared in OpenAPI
specs and enforced by <code>scopeMiddleware</code>. This works for basic access control but
falls short for multi-tenant or enterprise deployments where:</p>
<ul>
<li>Different users need different permission sets (operator can restart services
but not modify DNS; network admin can change DNS but not view jobs).</li>
<li>Audit logging (see <code>2026-02-15-feat-audit-logging.md</code>) needs to know <em>which
user</em> performed an action, not just that <em>a valid token</em> was used.</li>
<li>Customers will want to map OSAPI permissions to their existing AD/LDAP groups
or SSO provider roles.</li>
</ul>
<p>The goal is to introduce a capability-based RBAC model — inspired by Kubernetes
RBAC and Linux capabilities — where permissions are granular, composable into
roles, and the JWT <code>sub</code> claim identifies the acting user for audit purposes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="current-state">Current State<a href="#current-state" class="hash-link" aria-label="Direct link to Current State" title="Direct link to Current State">​</a></h2>
<ul>
<li>JWT claims: <code>{ roles: [&quot;admin&quot;], sub: &quot;john@dewey.ws&quot;, ... }</code></li>
<li><code>RoleHierarchy</code> maps role → implied scopes: <code>admin → [read, write, admin]</code></li>
<li>OpenAPI specs declare required scope per endpoint:
<code>security: [{ BearerAuth: [read] }]</code></li>
<li><code>scopeMiddleware</code> checks if any token role implies the required scope</li>
<li><code>hasScope()</code> does the matching; 403 on failure</li>
<li>No user identity is passed to handlers or logged beyond the JWT claims</li>
<li><code>unauthenticatedOperations</code> map exempts health probes</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="permissions-capabilities">Permissions (capabilities)<a href="#permissions-capabilities" class="hash-link" aria-label="Direct link to Permissions (capabilities)" title="Direct link to Permissions (capabilities)">​</a></h3>
<p>Define granular permissions modeled after <code>resource:verb</code> (Kubernetes style).
Each OpenAPI endpoint maps to exactly one permission:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">system:read          GET /system/hostname, GET /system/status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">network:read         GET /network/dns/{interface}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">network:write        PUT /network/dns, POST /network/ping</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">job:read             GET /job, GET /job/{id}, GET /job/stats, GET /job/workers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">job:write            POST /job, DELETE /job/{id}, POST /job/{id}/retry</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">health:read          GET /health/status</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">audit:read           GET /audit, GET /audit/{id}  (future)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Health probes (<code>GET /health</code>, <code>GET /health/ready</code>) remain unauthenticated.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="roles">Roles<a href="#roles" class="hash-link" aria-label="Direct link to Roles" title="Direct link to Roles">​</a></h3>
<p>Roles are named collections of permissions. Built-in roles provide backward
compatibility:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">admin     → [system:read, network:read, network:write, job:read,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">             job:write, health:read, audit:read]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">operator  → [system:read, network:read, job:read, job:write, health:read]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">read      → [system:read, network:read, job:read, health:read]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>write</code> role maps to <code>operator</code> for backward compatibility — existing tokens
with <code>roles: [&quot;write&quot;]</code> continue to work.</p>
<p>Custom roles can be defined in config for deployments that need non-standard
groupings:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">api</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">security</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">roles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">network-admin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> network</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">read</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> network</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">write</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">job-viewer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">read</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jwt-claims">JWT Claims<a href="#jwt-claims" class="hash-link" aria-label="Direct link to JWT Claims" title="Direct link to JWT Claims">​</a></h3>
<p>Extend <code>CustomClaims</code> to carry the user identity and optionally fine-grained
permissions:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">type</span><span class="token plain"> CustomClaims </span><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Roles       </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">`json:&quot;roles&quot; validate:&quot;required,dive&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Permissions </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token builtin" style="color:rgb(130, 170, 255)">string</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">`json:&quot;permissions,omitempty&quot;`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    jwt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">RegisteredClaims</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>sub</code> (Subject): identifies the user — required for audit logging</li>
<li><code>roles</code>: maps to built-in or custom role definitions</li>
<li><code>permissions</code>: optional override — if present, these are used directly instead
of resolving from roles. This allows an upstream IdP (AD, Okta, Keycloak) to
embed exact permissions in the token without OSAPI needing to know about the
IdP&#x27;s group structure.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="middleware-changes">Middleware Changes<a href="#middleware-changes" class="hash-link" aria-label="Direct link to Middleware Changes" title="Direct link to Middleware Changes">​</a></h3>
<p><code>scopeMiddleware</code> changes:</p>
<ol>
<li>Resolve effective permissions: if <code>claims.Permissions</code> is non-empty, use it
directly; otherwise expand <code>claims.Roles</code> through the role → permission
mapping.</li>
<li>Check if the required permission (from OpenAPI spec) is in the effective set.</li>
<li>Inject user identity into the request context so handlers and audit logging
can access it:
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;auth.subject&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> claims</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Subject</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;auth.roles&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> claims</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Roles</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ctx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">Set</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;auth.permissions&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> effectivePermissions</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="openapi-spec-changes">OpenAPI Spec Changes<a href="#openapi-spec-changes" class="hash-link" aria-label="Direct link to OpenAPI Spec Changes" title="Direct link to OpenAPI Spec Changes">​</a></h3>
<p>Update security schemes in each <code>api.yaml</code> to use the new permission names as
scopes:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">components</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">securitySchemes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">BearerAuth</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">scheme</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> bearer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">bearerFormat</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> JWT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Per endpoint:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">security</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">BearerAuth</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> system</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">read</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>oapi-codegen will pass <code>[&quot;system:read&quot;]</code> to the context, and <code>scopeMiddleware</code>
checks it against the resolved permission set.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="backward-compatibility">Backward Compatibility<a href="#backward-compatibility" class="hash-link" aria-label="Direct link to Backward Compatibility" title="Direct link to Backward Compatibility">​</a></h3>
<ul>
<li>Existing tokens with <code>roles: [&quot;admin&quot;]</code> or <code>roles: [&quot;read&quot;]</code> continue to work
— the role-to-permission mapping handles expansion.</li>
<li>The old <code>read</code>/<code>write</code>/<code>admin</code> scope names in OpenAPI specs are replaced with
<code>resource:verb</code> permissions, but the middleware resolves old role names
through the mapping.</li>
<li><code>osapi token generate --roles admin</code> still works. Add
<code>--permissions system:read,job:write</code> flag for fine-grained tokens.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-idp-integration-future">External IdP Integration (future)<a href="#external-idp-integration-future" class="hash-link" aria-label="Direct link to External IdP Integration (future)" title="Direct link to External IdP Integration (future)">​</a></h3>
<p>The design supports upstream identity providers without code changes:</p>
<ul>
<li><strong>OIDC/OAuth2</strong>: IdP issues JWTs with <code>roles</code> or <code>permissions</code> claims that
OSAPI validates. Map IdP groups → OSAPI roles in config.</li>
<li><strong>AD/LDAP</strong>: A gateway (e.g., Keycloak, Dex) translates AD groups to JWT
claims. OSAPI only sees the JWT.</li>
<li><strong>Custom</strong>: Any system that can produce a signed JWT with the expected claims
structure works. Configure the signing key or JWKS endpoint.</li>
</ul>
<p>This task does NOT implement IdP integration — it builds the permission model
that makes integration straightforward later.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-steps">Implementation Steps<a href="#implementation-steps" class="hash-link" aria-label="Direct link to Implementation Steps" title="Direct link to Implementation Steps">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-define-permissions-and-role-mappings">Step 1: Define permissions and role mappings<a href="#step-1-define-permissions-and-role-mappings" class="hash-link" aria-label="Direct link to Step 1: Define permissions and role mappings" title="Direct link to Step 1: Define permissions and role mappings">​</a></h3>
<ul>
<li>Create <code>internal/authtoken/permissions.go</code> with permission constants and the
role → permission mapping.</li>
<li>Update <code>RoleHierarchy</code> to map to permissions instead of the old flat scopes.</li>
<li>Add <code>Permissions</code> field to <code>CustomClaims</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-update-openapi-specs">Step 2: Update OpenAPI specs<a href="#step-2-update-openapi-specs" class="hash-link" aria-label="Direct link to Step 2: Update OpenAPI specs" title="Direct link to Step 2: Update OpenAPI specs">​</a></h3>
<ul>
<li>Replace <code>read</code>/<code>write</code> scopes with <code>resource:verb</code> permissions in every
<code>api.yaml</code> under <code>internal/api/*/gen/</code>.</li>
<li>Regenerate with <code>just generate</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-update-middleware">Step 3: Update middleware<a href="#step-3-update-middleware" class="hash-link" aria-label="Direct link to Step 3: Update middleware" title="Direct link to Step 3: Update middleware">​</a></h3>
<ul>
<li>Update <code>scopeMiddleware</code> to resolve permissions from roles or use direct
permissions from claims.</li>
<li>Inject user identity (<code>sub</code>, roles, permissions) into Echo context.</li>
<li>Update <code>hasScope</code> → <code>hasPermission</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-4-update-token-cli">Step 4: Update token CLI<a href="#step-4-update-token-cli" class="hash-link" aria-label="Direct link to Step 4: Update token CLI" title="Direct link to Step 4: Update token CLI">​</a></h3>
<ul>
<li>Add <code>--permissions</code> flag to <code>osapi token generate</code>.</li>
<li>Update <code>osapi token validate</code> to show resolved permissions.</li>
<li>Validate permission strings against known permissions.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-5-custom-roles-in-config">Step 5: Custom roles in config<a href="#step-5-custom-roles-in-config" class="hash-link" aria-label="Direct link to Step 5: Custom roles in config" title="Direct link to Step 5: Custom roles in config">​</a></h3>
<ul>
<li>Add <code>api.server.security.roles</code> config section.</li>
<li>Merge custom roles with built-in roles at startup.</li>
<li>Validate that custom role permissions reference known permissions.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-6-integration-tests">Step 6: Integration tests<a href="#step-6-integration-tests" class="hash-link" aria-label="Direct link to Step 6: Integration tests" title="Direct link to Step 6: Integration tests">​</a></h3>
<ul>
<li>Test each endpoint with tokens that have exactly the right permission (should
succeed) and tokens missing it (should 403).</li>
<li>Test backward compatibility: old <code>roles: [&quot;admin&quot;]</code> tokens still work.</li>
<li>Test <code>permissions</code> claim override bypasses role resolution.</li>
<li>Test custom roles from config.</li>
<li>Test that user identity (<code>sub</code>) is available in request context.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-7-documentation">Step 7: Documentation<a href="#step-7-documentation" class="hash-link" aria-label="Direct link to Step 7: Documentation" title="Direct link to Step 7: Documentation">​</a></h3>
<ul>
<li>Update <code>docs/docs/sidebar/configuration.md</code> with new roles config.</li>
<li>Add RBAC section to architecture docs explaining the permission model.</li>
<li>Update token generation docs with <code>--permissions</code> examples.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<ul>
<li>Keep the built-in roles simple — three is enough for most deployments. Custom
roles handle the edge cases.</li>
<li>Permission strings use <code>resource:verb</code> not <code>resource.verb</code> to avoid confusion
with NATS subject dots.</li>
<li>The <code>admin</code> role should always be a superset of all permissions.</li>
<li>This is a prerequisite for audit logging — once RBAC is in place, audit
middleware can read <code>auth.subject</code> from context.</li>
<li>Consider adding a <code>deny</code> list later for temporary permission revocation
without regenerating tokens.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="outcome">Outcome<a href="#outcome" class="hash-link" aria-label="Direct link to Outcome" title="Direct link to Outcome">​</a></h2>
<p>Implemented fine-grained RBAC with <code>resource:verb</code> permissions across all
domains. Key changes:</p>
<ul>
<li>Created <code>internal/authtoken/permissions.go</code> with permission constants,
<code>DefaultRolePermissions</code> map, <code>ResolvePermissions()</code>, and <code>HasPermission()</code>.</li>
<li>Added <code>Permissions []string</code> to <code>CustomClaims</code> and updated <code>Generate()</code>
signature.</li>
<li>Added <code>CustomRole</code> struct and <code>Roles</code> config to <code>ServerSecurity</code>.</li>
<li>Updated all 4 OpenAPI specs (<code>system</code>, <code>network</code>, <code>job</code>, <code>health</code>) to use
<code>resource:verb</code> scopes and regenerated code.</li>
<li>Rewrote <code>scopeMiddleware</code> to resolve permissions from roles/claims and inject
user identity (<code>auth.subject</code>, <code>auth.roles</code>) into context.</li>
<li>Added <code>--permissions/-p</code> flag to <code>osapi token generate</code> CLI.</li>
<li>Updated <code>osapi token validate</code> to show resolved effective permissions.</li>
<li>Added RBAC integration tests to all 13 authenticated endpoints across system
(2), network (3), job (7), and health (1) domains.</li>
<li>Renamed existing integration tests to <code>*Validation()</code> pattern.</li>
<li>Documented JWT signing trust model, token structure, permission resolution,
and custom roles in architecture and configuration docs.</li>
</ul></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-audit-log-export-backends"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Support audit log export to alternative backends</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osapi/sidebar/development/tasks/done/2026-02-21-feat-show-worker-labels"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Show worker labels in system hostname output</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#objective" class="table-of-contents__link toc-highlight">Objective</a></li><li><a href="#current-state" class="table-of-contents__link toc-highlight">Current State</a></li><li><a href="#design" class="table-of-contents__link toc-highlight">Design</a><ul><li><a href="#permissions-capabilities" class="table-of-contents__link toc-highlight">Permissions (capabilities)</a></li><li><a href="#roles" class="table-of-contents__link toc-highlight">Roles</a></li><li><a href="#jwt-claims" class="table-of-contents__link toc-highlight">JWT Claims</a></li><li><a href="#middleware-changes" class="table-of-contents__link toc-highlight">Middleware Changes</a></li><li><a href="#openapi-spec-changes" class="table-of-contents__link toc-highlight">OpenAPI Spec Changes</a></li><li><a href="#backward-compatibility" class="table-of-contents__link toc-highlight">Backward Compatibility</a></li><li><a href="#external-idp-integration-future" class="table-of-contents__link toc-highlight">External IdP Integration (future)</a></li></ul></li><li><a href="#implementation-steps" class="table-of-contents__link toc-highlight">Implementation Steps</a><ul><li><a href="#step-1-define-permissions-and-role-mappings" class="table-of-contents__link toc-highlight">Step 1: Define permissions and role mappings</a></li><li><a href="#step-2-update-openapi-specs" class="table-of-contents__link toc-highlight">Step 2: Update OpenAPI specs</a></li><li><a href="#step-3-update-middleware" class="table-of-contents__link toc-highlight">Step 3: Update middleware</a></li><li><a href="#step-4-update-token-cli" class="table-of-contents__link toc-highlight">Step 4: Update token CLI</a></li><li><a href="#step-5-custom-roles-in-config" class="table-of-contents__link toc-highlight">Step 5: Custom roles in config</a></li><li><a href="#step-6-integration-tests" class="table-of-contents__link toc-highlight">Step 6: Integration tests</a></li><li><a href="#step-7-documentation" class="table-of-contents__link toc-highlight">Step 7: Documentation</a></li></ul></li><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li><li><a href="#outcome" class="table-of-contents__link toc-highlight">Outcome</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/retr0h/osapi" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 <a href="https://github.com/retr0h">@retr0h</a></div></div></div></footer></div>
</body>
</html>