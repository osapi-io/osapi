<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-sidebar/architecture/system-architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">System Architecture | OSAPI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://osapi-io.github.io/osapi/sidebar/architecture/system-architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="System Architecture | OSAPI"><meta data-rh="true" name="description" content="OSAPI is a Linux system management platform that exposes a REST API for querying"><meta data-rh="true" property="og:description" content="OSAPI is a Linux system management platform that exposes a REST API for querying"><link data-rh="true" rel="icon" href="/osapi/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://osapi-io.github.io/osapi/sidebar/architecture/system-architecture"><link data-rh="true" rel="alternate" href="https://osapi-io.github.io/osapi/sidebar/architecture/system-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://osapi-io.github.io/osapi/sidebar/architecture/system-architecture" hreflang="x-default"><link rel="stylesheet" href="/osapi/assets/css/styles.56a51dbd.css">
<script src="/osapi/assets/js/runtime~main.a23799c6.js" defer="defer"></script>
<script src="/osapi/assets/js/main.1a546be3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/osapi/"><div class="navbar__logo"><img src="/osapi/img/logo.png" alt="OSAPI Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/osapi/img/logo.png" alt="OSAPI Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OSAPI</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/osapi/">Getting Started</a><a class="navbar__item navbar__link" href="/osapi/category/api">API</a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/osapi/sidebar/architecture/system-architecture">Next</a><a href="https://github.com/retr0h/osapi" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/osapi/">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/">Home</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/osapi/sidebar/architecture">Architecture</a><button aria-label="Collapse sidebar category &#x27;Architecture&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/osapi/sidebar/architecture/system-architecture">System Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/architecture/job-architecture">Job System Architecture</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/osapi/sidebar/usage">Usage</a><button aria-label="Expand sidebar category &#x27;Usage&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/development">Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/principles">Guiding Principles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/api-guidelines">API Design Guidelines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/osapi/sidebar/roadmap">Roadmap</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/osapi/category/api">API</a><button aria-label="Expand sidebar category &#x27;API&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/osapi/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Getting Started</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/osapi/sidebar/architecture"><span itemprop="name">Architecture</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">System Architecture</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><div class="row"><div class="col col--12 markdown"><header><h1>System Architecture</h1></header>
<p>OSAPI is a Linux system management platform that exposes a REST API for querying
and modifying host configuration and uses NATS JetStream for distributed,
asynchronous job processing. Operators interact with the system through a CLI
that can either hit the REST API directly or manage the job queue.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="component-map">Component Map<a href="#component-map" class="hash-link" aria-label="Direct link to Component Map" title="Direct link to Component Map">​</a></h2>
<p>The system is organized into six layers, top to bottom:</p>
<table><thead><tr><th>Layer</th><th>Package</th><th>Role</th></tr></thead><tbody><tr><td><strong>CLI</strong></td><td><code>cmd/</code></td><td>Cobra command tree (thin wiring)</td></tr><tr><td><strong>Generated HTTP Client</strong></td><td><code>internal/client/</code></td><td>OpenAPI-generated client used by CLI</td></tr><tr><td><strong>REST API</strong></td><td><code>internal/api/</code></td><td>Echo server with JWT middleware</td></tr><tr><td><strong>Job Client</strong></td><td><code>internal/job/client/</code></td><td>Business logic for job CRUD and status</td></tr><tr><td><strong>NATS JetStream</strong></td><td>(external)</td><td>KV <code>job-queue</code>, Stream <code>JOBS</code>, KV <code>job-responses</code></td></tr><tr><td><strong>Job Worker / Provider Layer</strong></td><td><code>internal/job/worker/</code>, <code>internal/provider/</code></td><td>Consumes jobs from NATS and executes providers</td></tr></tbody></table>
<!-- -->
<p>The CLI talks to the REST API through the generated HTTP client. The REST API
delegates state-changing operations to the job client, which stores jobs in NATS
KV and publishes notifications to the JOBS stream. Workers pick up
notifications, execute the matching provider, and write results back to KV.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entry-points">Entry Points<a href="#entry-points" class="hash-link" aria-label="Direct link to Entry Points" title="Direct link to Entry Points">​</a></h2>
<p>The <code>osapi</code> binary exposes four top-level command groups:</p>
<ul>
<li><strong><code>osapi api server start</code></strong> — starts the REST API server (Echo + JWT
middleware)</li>
<li><strong><code>osapi job worker start</code></strong> — starts a job worker that subscribes to NATS
subjects and processes operations</li>
<li><strong><code>osapi nats server start</code></strong> — starts an embedded NATS server with JetStream
enabled</li>
<li><strong><code>osapi client</code></strong> — CLI client that talks to the REST API (system, network,
job, and health subcommands)</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="layers">Layers<a href="#layers" class="hash-link" aria-label="Direct link to Layers" title="Direct link to Layers">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cli-cmd">CLI (<code>cmd/</code>)<a href="#cli-cmd" class="hash-link" aria-label="Direct link to cli-cmd" title="Direct link to cli-cmd">​</a></h3>
<p>The CLI is a <a href="https://github.com/spf13/cobra" target="_blank" rel="noopener noreferrer">Cobra</a> command tree. Each file maps to a single command (e.g.,
<code>client_job_add.go</code> implements <code>osapi client job add</code>). The CLI layer is thin
wiring: it parses flags, reads config via Viper, and delegates to the
appropriate internal package.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rest-api-internalapi">REST API (<code>internal/api/</code>)<a href="#rest-api-internalapi" class="hash-link" aria-label="Direct link to rest-api-internalapi" title="Direct link to rest-api-internalapi">​</a></h3>
<p>The API server is built on <a href="https://echo.labstack.com" target="_blank" rel="noopener noreferrer">Echo</a> with handlers generated from an OpenAPI spec
via <a href="https://github.com/oapi-codegen/oapi-codegen" target="_blank" rel="noopener noreferrer">oapi-codegen</a> (<code>*.gen.go</code> files). Domain handlers are organized into
subpackages:</p>
<table><thead><tr><th>Package</th><th>Responsibility</th></tr></thead><tbody><tr><td><code>internal/api/system/</code></td><td>System endpoints (hostname, status, uptime, disk, memory, load)</td></tr><tr><td><code>internal/api/network/</code></td><td>Network endpoints (DNS, ping)</td></tr><tr><td><code>internal/api/job/</code></td><td>Job queue endpoints (create, get, list, delete, status, workers)</td></tr><tr><td><code>internal/api/health/</code></td><td>Health check endpoints (liveness, readiness, status)</td></tr><tr><td><code>internal/api/common/</code></td><td>Shared middleware, error handling, collection responses</td></tr><tr><td>(metrics)</td><td>Prometheus endpoint (<code>/metrics</code>) via OpenTelemetry</td></tr></tbody></table>
<p>All state-changing operations are dispatched as jobs through the job client
layer rather than executed inline. Responses follow a uniform collection
envelope documented in the <a href="/osapi/sidebar/api-guidelines">API Design Guidelines</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="job-system-internaljob">Job System (<code>internal/job/</code>)<a href="#job-system-internaljob" class="hash-link" aria-label="Direct link to job-system-internaljob" title="Direct link to job-system-internaljob">​</a></h3>
<p>The job system implements a <strong>KV-first, stream-notification architecture</strong> on
NATS JetStream. Core types live in <code>internal/job/</code>, with two subpackages:</p>
<table><thead><tr><th>Package</th><th>Purpose</th></tr></thead><tbody><tr><td><code>internal/job/client/</code></td><td>High-level operations (create, status, query)</td></tr><tr><td><code>internal/job/worker/</code></td><td>Consumer pipeline (subscribe, handle, process)</td></tr></tbody></table>
<p>Subject routing uses dot-notation hierarchies (<code>jobs.query.*</code>, <code>jobs.modify.*</code>)
with support for load-balanced (<code>_any</code>), broadcast (<code>_all</code>), direct-host, and
label-based targeting.</p>
<p>For the full deep dive see <a href="/osapi/sidebar/architecture/job-architecture">Job System Architecture</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="provider-layer-internalprovider">Provider Layer (<code>internal/provider/</code>)<a href="#provider-layer-internalprovider" class="hash-link" aria-label="Direct link to provider-layer-internalprovider" title="Direct link to provider-layer-internalprovider">​</a></h3>
<p>Providers implement the actual system operations behind a common interface. Each
provider is selected at runtime through a platform-aware factory pattern.</p>
<table><thead><tr><th>Domain</th><th>Providers</th></tr></thead><tbody><tr><td><code>system/host</code></td><td>Hostname, uptime, OS info</td></tr><tr><td><code>system/disk</code></td><td>Disk usage statistics</td></tr><tr><td><code>system/mem</code></td><td>Memory usage statistics</td></tr><tr><td><code>system/load</code></td><td>Load average statistics</td></tr><tr><td><code>network/dns</code></td><td>DNS configuration (get/update)</td></tr><tr><td><code>network/ping</code></td><td>Ping execution and statistics</td></tr></tbody></table>
<p>Providers are stateless and platform-specific (e.g., a Ubuntu DNS provider vs. a
generic Linux DNS provider). Adding a new operation means implementing the
provider interface and registering it in the worker&#x27;s processor dispatch.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-internalconfig">Configuration (<code>internal/config/</code>)<a href="#configuration-internalconfig" class="hash-link" aria-label="Direct link to configuration-internalconfig" title="Direct link to configuration-internalconfig">​</a></h3>
<p>Configuration is managed by <a href="https://github.com/spf13/viper" target="_blank" rel="noopener noreferrer">Viper</a> and loaded from an <code>osapi.yaml</code> file.
Environment variables override file values using the <code>OSAPI_</code> prefix with
underscore-separated keys (e.g., <code>OSAPI_API_SERVER_PORT</code>).</p>
<p>Minimal configuration skeleton (see <a href="/osapi/sidebar/configuration">Configuration</a> for the
full reference):</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">api</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">client</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://localhost:8080&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">security</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">bearer_token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&lt;jwt&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">nats</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;localhost&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">client_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;osapi-api&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">security</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">signing_key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;&lt;secret&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">cors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">allow_origins</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">nats</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">server</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;0.0.0.0&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">store_dir</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;/tmp/nats-store&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">job</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">stream_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;JOBS&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">kv_bucket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;job-queue&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">kv_response_bucket</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;job-responses&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">consumer_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;jobs-worker&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">worker</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">nats</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;localhost&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">port</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">client_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;osapi-job-worker&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">hostname</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;worker-01&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">group</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;web.dev&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="health-checks-internalapihealth">Health Checks (<code>internal/api/health/</code>)<a href="#health-checks-internalapihealth" class="hash-link" aria-label="Direct link to health-checks-internalapihealth" title="Direct link to health-checks-internalapihealth">​</a></h2>
<p>The API server exposes three health check endpoints following the Kubernetes
liveness/readiness probe pattern. These endpoints live outside the <code>/api/v1/</code>
prefix at <code>/health</code> because they serve infrastructure concerns rather than
business operations.</p>
<table><thead><tr><th>Endpoint</th><th>Auth</th><th>Purpose</th></tr></thead><tbody><tr><td><code>GET /health</code></td><td>None</td><td>Liveness — returns 200 if the process runs</td></tr><tr><td><code>GET /health/ready</code></td><td>None</td><td>Readiness — verifies dependencies</td></tr><tr><td><code>GET /health/status</code></td><td>JWT <code>read</code></td><td>System status with metrics for operators</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="liveness-health">Liveness (<code>/health</code>)<a href="#liveness-health" class="hash-link" aria-label="Direct link to liveness-health" title="Direct link to liveness-health">​</a></h3>
<p>Returns <code>{&quot;status&quot;:&quot;ok&quot;}</code> unconditionally. No dependency checks are performed.
If the HTTP server responds, the process is alive. This endpoint is deliberately
trivial — putting dependency checks here would cause orchestrators to restart
the process during a transient NATS outage, creating a restart storm on top of
the original problem.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="readiness-healthready">Readiness (<code>/health/ready</code>)<a href="#readiness-healthready" class="hash-link" aria-label="Direct link to readiness-healthready" title="Direct link to readiness-healthready">​</a></h3>
<p>Runs all checks registered with the <code>Checker</code> interface and returns 200
(<code>ready</code>) or 503 (<code>not_ready</code>). The default checker (<code>NATSChecker</code>) verifies:</p>
<ul>
<li><strong>NATS connectivity</strong> — the NATS connection is active and has a connected URL</li>
<li><strong>KV bucket access</strong> — the <code>job-queue</code> KV bucket is reachable and can list
keys</li>
</ul>
<p>Load balancers should use this endpoint to decide whether to route traffic. When
readiness fails, the server stays running but stops receiving requests until the
dependency recovers.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="status-healthstatus">Status (<code>/health/status</code>)<a href="#status-healthstatus" class="hash-link" aria-label="Direct link to status-healthstatus" title="Direct link to status-healthstatus">​</a></h3>
<p>Breaks out each dependency as a named component with its own status and error
message. Also reports NATS connection info, JetStream stream statistics, KV
bucket statistics, job queue counts, application version, and uptime. Returns
<code>ok</code> when all components are healthy or <code>degraded</code> (with HTTP 503) when any
component fails. Requires JWT authentication because it exposes internal
topology.</p>
<p>Components checked:</p>
<table><thead><tr><th>Component</th><th>What it checks</th></tr></thead><tbody><tr><td><code>nats</code></td><td>NATS client is connected</td></tr><tr><td><code>kv</code></td><td><code>job-queue</code> KV bucket is accessible</td></tr></tbody></table>
<p>Additional metrics (optional, gracefully skipped on failure):</p>
<table><thead><tr><th>Section</th><th>What it reports</th></tr></thead><tbody><tr><td><code>nats</code></td><td>Connected URL, server version</td></tr><tr><td><code>streams</code></td><td>Message count, bytes, consumer count</td></tr><tr><td><code>kv</code></td><td>Bucket name, key count, bytes</td></tr><tr><td><code>jobs</code></td><td>Total, unprocessed, processing, completed, failed, DLQ</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cli-access">CLI Access<a href="#cli-access" class="hash-link" aria-label="Direct link to CLI Access" title="Direct link to CLI Access">​</a></h3>
<p>Operators can check health from the command line:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">osapi client health              # liveness</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">osapi client health ready        # readiness</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">osapi client health status       # system status with metrics (requires auth)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="request-flow">Request Flow<a href="#request-flow" class="hash-link" aria-label="Direct link to Request Flow" title="Direct link to Request Flow">​</a></h2>
<p>A typical operation (e.g., <code>system.hostname.get</code>) follows these steps:</p>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a href="#security" class="hash-link" aria-label="Direct link to Security" title="Direct link to Security">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentication">Authentication<a href="#authentication" class="hash-link" aria-label="Direct link to Authentication" title="Direct link to Authentication">​</a></h3>
<p>The API uses <strong>JWT HS256</strong> tokens signed with a shared secret
(<code>security.signing_key</code>). Tokens carry a <code>role</code> claim that determines the
caller&#x27;s access level. The <code>osapi token generate</code> command creates tokens for a
given role.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authorization">Authorization<a href="#authorization" class="hash-link" aria-label="Direct link to Authorization" title="Direct link to Authorization">​</a></h3>
<p>Access control is scope-based with a three-tier role hierarchy:</p>
<table><thead><tr><th>Role</th><th>Scopes</th></tr></thead><tbody><tr><td><code>admin</code></td><td><code>read</code>, <code>write</code>, <code>admin</code></td></tr><tr><td><code>write</code></td><td><code>read</code>, <code>write</code></td></tr><tr><td><code>read</code></td><td><code>read</code></td></tr></tbody></table>
<p>Each API endpoint declares a required scope. The JWT middleware checks that the
caller&#x27;s role includes that scope before allowing the request. The health
endpoints <code>/health</code> and <code>/health/ready</code> are exceptions — they bypass JWT
authentication so that load balancers and orchestrators can probe them without
credentials.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cors">CORS<a href="#cors" class="hash-link" aria-label="Direct link to CORS" title="Direct link to CORS">​</a></h3>
<p>Cross-Origin Resource Sharing is configured per-server via
<code>api.server.security.cors.allow_origins</code> in <code>osapi.yaml</code>. An empty list disables
CORS headers entirely.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="external-dependencies">External Dependencies<a href="#external-dependencies" class="hash-link" aria-label="Direct link to External Dependencies" title="Direct link to External Dependencies">​</a></h2>
<table><thead><tr><th>Dependency</th><th>Purpose</th></tr></thead><tbody><tr><td><a href="https://echo.labstack.com" target="_blank" rel="noopener noreferrer">Echo</a></td><td>HTTP framework for the REST API</td></tr><tr><td><a href="https://github.com/spf13/cobra" target="_blank" rel="noopener noreferrer">Cobra</a> / <a href="https://github.com/spf13/viper" target="_blank" rel="noopener noreferrer">Viper</a></td><td>CLI framework and configuration</td></tr><tr><td><a href="https://nats.io" target="_blank" rel="noopener noreferrer">NATS</a> / JetStream</td><td>Messaging, KV store, stream processing</td></tr><tr><td><a href="https://github.com/oapi-codegen/oapi-codegen" target="_blank" rel="noopener noreferrer">oapi-codegen</a></td><td>OpenAPI strict-server code generation</td></tr><tr><td><a href="https://opentelemetry.io" target="_blank" rel="noopener noreferrer">OpenTelemetry</a></td><td>Distributed tracing and Prometheus metrics</td></tr><tr><td><a href="https://github.com/shirou/gopsutil" target="_blank" rel="noopener noreferrer">gopsutil</a></td><td>Cross-platform system metrics</td></tr><tr><td><a href="https://github.com/prometheus-community/pro-bing" target="_blank" rel="noopener noreferrer">pro-bing</a></td><td>ICMP ping implementation</td></tr><tr><td><a href="https://github.com/golang-jwt/jwt" target="_blank" rel="noopener noreferrer">golang-jwt</a></td><td>JWT creation and validation</td></tr><tr><td><code>nats-client</code> / <code>nats-server</code></td><td>Sibling repos (linked via <code>go.mod</code> replace)</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-reading">Further Reading<a href="#further-reading" class="hash-link" aria-label="Direct link to Further Reading" title="Direct link to Further Reading">​</a></h2>
<ul>
<li><a href="/osapi/sidebar/architecture/job-architecture">Job System Architecture</a> — deep dive into the KV-first
job system, subject routing, and worker pipeline</li>
<li><a href="/osapi/sidebar/api-guidelines">API Design Guidelines</a> — REST conventions, collection
envelopes, and endpoint patterns</li>
<li><a href="/osapi/sidebar/principles">Guiding Principles</a> — design philosophy and project values</li>
<li><a href="/osapi/sidebar/development">Development</a> — setup, building, testing, and contributing</li>
</ul></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/osapi/sidebar/architecture"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/osapi/sidebar/architecture/job-architecture"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Job System Architecture</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#component-map" class="table-of-contents__link toc-highlight">Component Map</a></li><li><a href="#entry-points" class="table-of-contents__link toc-highlight">Entry Points</a></li><li><a href="#layers" class="table-of-contents__link toc-highlight">Layers</a><ul><li><a href="#cli-cmd" class="table-of-contents__link toc-highlight">CLI (<code>cmd/</code>)</a></li><li><a href="#rest-api-internalapi" class="table-of-contents__link toc-highlight">REST API (<code>internal/api/</code>)</a></li><li><a href="#job-system-internaljob" class="table-of-contents__link toc-highlight">Job System (<code>internal/job/</code>)</a></li><li><a href="#provider-layer-internalprovider" class="table-of-contents__link toc-highlight">Provider Layer (<code>internal/provider/</code>)</a></li><li><a href="#configuration-internalconfig" class="table-of-contents__link toc-highlight">Configuration (<code>internal/config/</code>)</a></li></ul></li><li><a href="#health-checks-internalapihealth" class="table-of-contents__link toc-highlight">Health Checks (<code>internal/api/health/</code>)</a><ul><li><a href="#liveness-health" class="table-of-contents__link toc-highlight">Liveness (<code>/health</code>)</a></li><li><a href="#readiness-healthready" class="table-of-contents__link toc-highlight">Readiness (<code>/health/ready</code>)</a></li><li><a href="#status-healthstatus" class="table-of-contents__link toc-highlight">Status (<code>/health/status</code>)</a></li><li><a href="#cli-access" class="table-of-contents__link toc-highlight">CLI Access</a></li></ul></li><li><a href="#request-flow" class="table-of-contents__link toc-highlight">Request Flow</a></li><li><a href="#security" class="table-of-contents__link toc-highlight">Security</a><ul><li><a href="#authentication" class="table-of-contents__link toc-highlight">Authentication</a></li><li><a href="#authorization" class="table-of-contents__link toc-highlight">Authorization</a></li><li><a href="#cors" class="table-of-contents__link toc-highlight">CORS</a></li></ul></li><li><a href="#external-dependencies" class="table-of-contents__link toc-highlight">External Dependencies</a></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further Reading</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/retr0h/osapi" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 <a href="https://github.com/retr0h">@retr0h</a></div></div></div></footer></div>
</body>
</html>