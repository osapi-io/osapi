---
date: 2026-02-27
---

## Summary

Implemented Phase 1 (agent/node taxonomy split), Phase 2 (health status
enhancements), and Phase 3 (documentation) of the agent-node taxonomy
reorganization plan.

## Changes

### Phase 1: Agent/Node Split

- Created `internal/api/agent/` package with full OpenAPI spec, handlers, and
  tests for `GET /agent` (list) and `GET /agent/{hostname}` (get detail)
- Trimmed `internal/api/node/` to keep only `GET /node/hostname` and
  `GET /node/status`
- Added `agent:read` permission to `internal/authtoken/permissions.go` and all
  three default roles
- Created `internal/api/handler_agent.go` for server wiring with
  `scopeMiddleware`
- Created CLI commands: `cmd/client_agent.go`, `cmd/client_agent_list.go`,
  `cmd/client_agent_get.go`
- Deleted `cmd/client_node_list.go`, `cmd/client_node_get.go`
- Updated SDK: new `AgentService` in `osapi-sdk/pkg/osapi/agent.go`, trimmed
  `NodeService`, regenerated merged spec and client code

### Phase 2: Health Status Enhancements

- Updated `newMetricsProvider` to accept `registryKV` and `auditKV` params,
  querying all KV buckets (not just jobsKV)
- Added `ConsumerMetrics` type and `GetConsumerStats` to
  `MetricsProvider` interface
- Added `ConsumerStats` schema to health OpenAPI spec and `consumers` field to
  `StatusResponse`
- Updated health handler to populate consumer stats
- Updated CLI health status display with consumer count
- Updated SDK health spec and regenerated

### Phase 3: Documentation

- Created `docs/docs/sidebar/usage/cli/client/agent/` with `agent.mdx`,
  `list.md`, `get.md`
- Updated `node/node.mdx` to reference only job-based commands
- Removed `node/list.md` and `node/get.md` (moved to agent/)
- Updated `features/node-management.md` to clarify agent vs node distinction
- Updated `configuration.md` with `agent:read` permission in roles table

## Decisions

- Agent endpoints use `agent:read` permission; node endpoints keep `node:read`
- All three default roles (admin, write, read) include `agent:read`
- SDK linked via `replace` directive in go.mod during development

### Agent CLI + Config Rename

- Renamed CLI: `osapi node agent start` → `osapi agent start`
- Renamed config: `node.agent.*` → `agent.*`
- Renamed types: `NodeAgent` → `AgentConfig`, `NodeAgentConsumer` →
  `AgentConsumer`, removed `Node` wrapper struct
- Updated all 4 YAML config files, all agent test files, CLI docs, and
  architecture docs
- Moved CLI docs from `cli/node/agent/` to `cli/agent/`

## Decisions

- Agent endpoints use `agent:read` permission; node endpoints keep `node:read`
- All three default roles (admin, write, read) include `agent:read`
- SDK linked via `replace` directive in go.mod during development
- `agent` is now a top-level CLI command (sibling of `api`, `nats`, `client`)
  rather than nested under `node`

## Next Steps

- Commit and push changes for review
- After SDK merge, remove `replace` directive from go.mod
- Move task file to `done/` when merged
