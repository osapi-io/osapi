"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8309],{40990(e,n,s){s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var i=s(74848),d=s(28453);const o={title:"Ad-hoc command execution",status:"done",created:new Date("2026-02-15T00:00:00.000Z"),updated:new Date("2026-02-22T00:00:00.000Z")},t=void 0,c={id:"sidebar/development/tasks/done/2026-02-15-feat-command-execution",title:"Ad-hoc command execution",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-15-feat-command-execution.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-15-feat-command-execution",permalink:"/osapi/sidebar/development/tasks/done/2026-02-15-feat-command-execution",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Ad-hoc command execution",status:"done",created:"2026-02-15T00:00:00.000Z",updated:"2026-02-22T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Audit logging for API operations",permalink:"/osapi/sidebar/development/tasks/done/2026-02-15-feat-audit-logging"},next:{title:"Health check and readiness endpoints",permalink:"/osapi/sidebar/development/tasks/done/2026-02-15-feat-health-endpoint"}},r={},l=[{value:"Objective",id:"objective",level:2},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"Operations",id:"operations",level:2},{value:"Request Body",id:"request-body",level:2},{value:"Response",id:"response",level:2},{value:"Provider",id:"provider",level:2},{value:"Notes",id:"notes",level:2},{value:"Outcome",id:"outcome",level:2}];function a(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,i.jsxs)(n.p,{children:["Add controlled command execution. Ansible's ",(0,i.jsx)(n.code,{children:"command"}),", ",(0,i.jsx)(n.code,{children:"shell"}),", and ",(0,i.jsx)(n.code,{children:"raw"}),"\nmodules are foundational \u2014 they allow running arbitrary commands when no\npurpose-built module exists. An appliance API needs this as a fallback for\noperations not covered by specific endpoints."]}),"\n",(0,i.jsx)(n.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"POST   /command/exec         - Execute command (no shell, no pipes)\nPOST   /command/shell        - Execute via shell (supports pipes, etc.)\n"})}),"\n",(0,i.jsx)(n.h2,{id:"operations",children:"Operations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"command.exec.execute"})," (modify)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"command.shell.execute"})," (modify)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"request-body",children:"Request Body"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "command": "whoami",\n  "args": [],\n  "cwd": "/tmp",\n  "timeout": 30,\n  "user": "root"\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"response",children:"Response"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "stdout": "root\\n",\n  "stderr": "",\n  "exit_code": 0,\n  "duration_ms": 12\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"provider",children:"Provider"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"internal/provider/node/command/"})}),"\n",(0,i.jsxs)(n.li,{children:["Use existing ",(0,i.jsx)(n.code,{children:"cmdexec"})," package for execution"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"exec"})," mode: no shell interpretation (safer, like Ansible ",(0,i.jsx)(n.code,{children:"command"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"shell"})," mode: runs through ",(0,i.jsx)(n.code,{children:"/bin/sh -c"})," (like Ansible ",(0,i.jsx)(n.code,{children:"shell"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"Support timeout, working directory, run-as user"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"This is the most security-sensitive feature \u2014 needs careful controls"}),"\n",(0,i.jsx)(n.li,{children:"Consider command allowlisting or denylisting"}),"\n",(0,i.jsxs)(n.li,{children:["Require highest privilege scope: ",(0,i.jsx)(n.code,{children:"command:execute"})]}),"\n",(0,i.jsx)(n.li,{children:"Log all executions to audit log"}),"\n",(0,i.jsx)(n.li,{children:"Set hard timeout limits (max 5 minutes?)"}),"\n",(0,i.jsxs)(n.li,{children:["The existing ",(0,i.jsx)(n.code,{children:"cmdexec.Manager"})," already provides safe execution"]}),"\n",(0,i.jsx)(n.li,{children:"Long-running commands are a natural fit for the async job system"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,i.jsx)(n.p,{children:"Implemented the full command execution domain:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Provider"}),": ",(0,i.jsx)(n.code,{children:"internal/provider/command/"})," with ",(0,i.jsx)(n.code,{children:"Exec()"})," and ",(0,i.jsx)(n.code,{children:"Shell()"})," methods\nusing the new ",(0,i.jsx)(n.code,{children:"exec.RunCmdFull()"})," for separate stdout/stderr"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"OpenAPI"}),": Two POST endpoints (",(0,i.jsx)(n.code,{children:"/command/exec"}),", ",(0,i.jsx)(n.code,{children:"/command/shell"}),") with\nvalidation, auth, and 202 async responses"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Job system"}),": Operation constants, data structs, job client methods\n(single + broadcast), and worker processor dispatch"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Permissions"}),": ",(0,i.jsx)(n.code,{children:"command:execute"})," permission, admin-only by default"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"CLI"}),": ",(0,i.jsx)(n.code,{children:"osapi client command exec"})," and ",(0,i.jsx)(n.code,{children:"osapi client command shell"})," with\n",(0,i.jsx)(n.code,{children:"--command"}),", ",(0,i.jsx)(n.code,{children:"--args"}),", ",(0,i.jsx)(n.code,{children:"--cwd"}),", ",(0,i.jsx)(n.code,{children:"--timeout"}),", ",(0,i.jsx)(n.code,{children:"--target"}),", ",(0,i.jsx)(n.code,{children:"--json"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Tests"}),": 22 new tests (unit + integration + RBAC), all passing"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Docs"}),": Feature page, CLI pages, config/permission updates"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"run-as user"})," deferred (requires syscall.SysProcAttr, linux-only)"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>t,x:()=>c});var i=s(96540);const d={},o=i.createContext(d);function t(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);