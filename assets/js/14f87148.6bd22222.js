"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5934],{42170(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var t=r(74848),i=r(28453);const s={title:"Distributed tracing with OpenTelemetry",status:"done",created:new Date("2026-02-20T00:00:00.000Z"),updated:new Date("2026-02-20T00:00:00.000Z")},o=void 0,a={id:"sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing",title:"Distributed tracing with OpenTelemetry",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Distributed tracing with OpenTelemetry",status:"done",created:"2026-02-20T00:00:00.000Z",updated:"2026-02-20T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Surface job IDs in API responses and CLI output",permalink:"/osapi/sidebar/development/tasks/done/2026-02-19-quick-wins-job-id-tracing"},next:{title:"HTTP metrics with Prometheus endpoint",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint"}},l={},d=[{value:"Objective",id:"objective",level:2},{value:"Prerequisite",id:"prerequisite",level:2},{value:"Approach",id:"approach",level:2},{value:"Key Go Packages",id:"key-go-packages",level:3},{value:"Scope",id:"scope",level:2},{value:"Tracer Provider Setup",id:"tracer-provider-setup",level:3},{value:"HTTP Layer (Echo API Server)",id:"http-layer-echo-api-server",level:3},{value:"HTTP Client (CLI \u2192 API)",id:"http-client-cli--api",level:3},{value:"NATS Propagation",id:"nats-propagation",level:3},{value:"Worker Spans",id:"worker-spans",level:3},{value:"slog Integration",id:"slog-integration",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Components to Update",id:"components-to-update",level:3},{value:"Notes",id:"notes",level:2},{value:"Outcome",id:"outcome",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,t.jsx)(n.p,{children:"Add end-to-end distributed tracing using OpenTelemetry (OTel) so that a single\ntrace ID follows a request from CLI or API origin, through NATS messaging, to\nworker execution and back. After this work, filtering logs by trace ID should\nshow the full flow of any request across all components."}),"\n",(0,t.jsx)(n.h2,{id:"prerequisite",children:"Prerequisite"}),"\n",(0,t.jsx)(n.p,{children:"Job IDs are already surfaced in API responses and CLI output (done). This task\nadds trace context propagation so that the trace ID correlates all log lines and\nspans across components automatically."}),"\n",(0,t.jsx)(n.h2,{id:"approach",children:"Approach"}),"\n",(0,t.jsx)(n.p,{children:"Use the OpenTelemetry Go SDK (CNCF standard):"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Trace ID as correlation ID"})," \u2014 W3C ",(0,t.jsx)(n.code,{children:"traceparent"})," header carries a globally\nunique trace ID across HTTP and NATS boundaries"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Automatic context propagation"})," \u2014 no custom headers needed"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Span-based instrumentation"})," \u2014 each operation (HTTP request, KV read, job\nprocessing) becomes a span with timing and attributes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"slog integration"})," \u2014 ",(0,t.jsx)(n.code,{children:"otelslog"})," bridge attaches ",(0,t.jsx)(n.code,{children:"trace_id"})," and ",(0,t.jsx)(n.code,{children:"span_id"})," to\nall structured log lines automatically"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Echo middleware"})," \u2014 ",(0,t.jsx)(n.code,{children:"otelecho"})," instruments all HTTP handlers with zero\nper-handler code"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"key-go-packages",children:"Key Go Packages"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/otel"})," \u2014 core API"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/otel/sdk/trace"})," \u2014 trace SDK"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/contrib/instrumentation/github.com/labstack/echo/otelecho"}),"\n\u2014 Echo middleware"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/otel/exporters/stdout/stdouttrace"})," \u2014 stdout exporter for\ndebug mode"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/otel/exporters/otlp/otlptrace"})," \u2014 OTLP exporter for\nproduction backends (Jaeger, Tempo, etc.)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.opentelemetry.io/otel/bridge/otelslog"})," \u2014 slog bridge"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"scope",children:"Scope"}),"\n",(0,t.jsx)(n.h3,{id:"tracer-provider-setup",children:"Tracer Provider Setup"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Initialize OTel tracer provider at startup in API server, worker, and CLI"}),"\n",(0,t.jsxs)(n.li,{children:["Use stdout exporter when ",(0,t.jsx)(n.code,{children:"--debug"})," is enabled"]}),"\n",(0,t.jsx)(n.li,{children:"Use OTLP exporter when configured (optional, for production)"}),"\n",(0,t.jsx)(n.li,{children:"Use noop tracer when tracing is not enabled (zero overhead)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"http-layer-echo-api-server",children:"HTTP Layer (Echo API Server)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add ",(0,t.jsx)(n.code,{children:"otelecho"})," middleware to instrument all HTTP handlers"]}),"\n",(0,t.jsxs)(n.li,{children:["Trace context propagates automatically via W3C ",(0,t.jsx)(n.code,{children:"traceparent"})," header"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"http-client-cli--api",children:"HTTP Client (CLI \u2192 API)"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Inject OTel propagator into HTTP client so outgoing requests carry\n",(0,t.jsx)(n.code,{children:"traceparent"})]}),"\n",(0,t.jsx)(n.li,{children:"CLI creates root span, API server continues the trace"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"nats-propagation",children:"NATS Propagation"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["nats-client ",(0,t.jsx)(n.code,{children:"Publish"})," automatically injects W3C ",(0,t.jsx)(n.code,{children:"traceparent"})," into NATS\nmessage headers via OTel \u2014 callers just pass ",(0,t.jsx)(n.code,{children:"ctx"})]}),"\n",(0,t.jsx)(n.li,{children:"Worker extracts trace context from NATS message headers"}),"\n",(0,t.jsxs)(n.li,{children:["Header keys are normalized on extraction because NATS JetStream delivers\nheaders with non-canonical casing (lowercase ",(0,t.jsx)(n.code,{children:"traceparent"})," instead of\n",(0,t.jsx)(n.code,{children:"Traceparent"}),"), which breaks ",(0,t.jsx)(n.code,{children:"http.Header.Get"})," lookups"]}),"\n",(0,t.jsx)(n.li,{children:"This links API-side spans to worker-side spans under the same trace"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"worker-spans",children:"Worker Spans"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Create spans for job processing, provider execution, result writes"}),"\n",(0,t.jsx)(n.li,{children:"Attach job ID, operation type, and target as span attributes"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"slog-integration",children:"slog Integration"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.code,{children:"otelslog"})," bridge so that ",(0,t.jsx)(n.code,{children:"trace_id"})," and ",(0,t.jsx)(n.code,{children:"span_id"})," appear in all\nstructured log lines automatically"]}),"\n",(0,t.jsxs)(n.li,{children:["Enables ",(0,t.jsx)(n.code,{children:"grep trace_id=<hex>"})," to see full end-to-end flow in logs"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Add optional config section to ",(0,t.jsx)(n.code,{children:"osapi.yaml"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'telemetry:\n  tracing:\n    # Enable tracing (default: false, --debug also enables stdout)\n    enabled: false\n    # OTLP endpoint for production tracing backends\n    # otlp_endpoint: "localhost:4317"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"components-to-update",children:"Components to Update"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/api_server_start.go"})," \u2014 init tracer provider, add ",(0,t.jsx)(n.code,{children:"otelecho"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/job_worker_start.go"})," \u2014 init tracer provider for worker"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/"})," (CLI commands) \u2014 init tracer provider, create root spans"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/client/"})," \u2014 inject OTel propagator into HTTP client"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/client/"})," \u2014 inject trace context into NATS headers"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/worker/"})," \u2014 extract trace context from NATS headers, create\nprocessing spans"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/config/"})," \u2014 add ",(0,t.jsx)(n.code,{children:"telemetry.tracing"})," config section"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["NATS does not have an official OTel instrumentation library, so trace context\ninjection/extraction will be manual (set/read ",(0,t.jsx)(n.code,{children:"traceparent"})," header on\nmessages)"]}),"\n",(0,t.jsx)(n.li,{children:"Keep backwards compatible \u2014 missing trace context should not cause errors,\njust start a new trace"}),"\n",(0,t.jsxs)(n.li,{children:["The stdout exporter is sufficient for ",(0,t.jsx)(n.code,{children:"--debug"})," \u2014 no Jaeger needed during\ndevelopment"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,t.jsx)(n.p,{children:"Implemented end-to-end distributed tracing with OpenTelemetry:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Created ",(0,t.jsx)(n.code,{children:"internal/telemetry/"})," package with tracer initialization, header and\nmap-based trace propagation, and slog trace handler"]}),"\n",(0,t.jsxs)(n.li,{children:["Added ",(0,t.jsx)(n.code,{children:"Telemetry"})," and ",(0,t.jsx)(n.code,{children:"TracingConfig"})," types to ",(0,t.jsx)(n.code,{children:"internal/config/"})]}),"\n",(0,t.jsxs)(n.li,{children:["Added ",(0,t.jsx)(n.code,{children:"otelecho"})," middleware to the Echo API server"]}),"\n",(0,t.jsxs)(n.li,{children:["Injected ",(0,t.jsx)(n.code,{children:"traceparent"})," into HTTP client outgoing requests"]}),"\n",(0,t.jsxs)(n.li,{children:["nats-client ",(0,t.jsx)(n.code,{children:"Publish"})," transparently injects trace context into NATS message\nheaders via OTel propagator \u2014 no caller changes needed"]}),"\n",(0,t.jsxs)(n.li,{children:["Worker extracts trace context from NATS message headers and creates a\n",(0,t.jsx)(n.code,{children:"job.process"})," span with job attributes"]}),"\n",(0,t.jsx)(n.li,{children:"Header key normalization handles NATS JetStream delivering headers with\nnon-canonical casing (lowercase instead of canonical MIME format)"}),"\n",(0,t.jsxs)(n.li,{children:["All slog output automatically includes ",(0,t.jsx)(n.code,{children:"trace_id"})," and ",(0,t.jsx)(n.code,{children:"span_id"})," when a span is\nactive"]}),"\n",(0,t.jsx)(n.li,{children:"Tracer provider initialized at startup in API server, worker, and CLI with\nproper shutdown"}),"\n",(0,t.jsx)(n.li,{children:"Debug mode auto-enables stdout tracing"}),"\n",(0,t.jsxs)(n.li,{children:["Updated ",(0,t.jsx)(n.code,{children:"osapi.yaml"})," and configuration docs"]}),"\n",(0,t.jsx)(n.li,{children:"All tests pass (9 new tests in telemetry package including non-canonical\nheader roundtrip, all existing tests passing)"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453(e,n,r){r.d(n,{R:()=>o,x:()=>a});var t=r(96540);const i={},s=t.createContext(i);function o(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);