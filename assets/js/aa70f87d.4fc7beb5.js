"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5607],{53451(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>c});var r=s(74848),i=s(28453);const t={sidebar_position:3},o="Job System Architecture",l={id:"sidebar/architecture/job-architecture",title:"Job System Architecture",description:"Date Implemented Author: @retr0h",source:"@site/docs/sidebar/architecture/job-architecture.md",sourceDirName:"sidebar/architecture",slug:"/sidebar/architecture/job-architecture",permalink:"/osapi/sidebar/architecture/job-architecture",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"testSidebar",previous:{title:"System Architecture",permalink:"/osapi/sidebar/architecture/system-architecture"},next:{title:"Usage",permalink:"/osapi/sidebar/usage/"}},d={},c=[{value:"Overview",id:"overview",level:2},{value:"Architecture Principles",id:"architecture-principles",level:2},{value:"System Components",id:"system-components",level:2},{value:"Core Components",id:"core-components",level:3},{value:"Job Flow",id:"job-flow",level:3},{value:"NATS Configuration",id:"nats-configuration",level:2},{value:"KV Buckets",id:"kv-buckets",level:3},{value:"JetStream Configuration",id:"jetstream-configuration",level:3},{value:"Subject Hierarchy",id:"subject-hierarchy",level:2},{value:"Semantic Routing Rules",id:"semantic-routing-rules",level:3},{value:"Target Types",id:"target-types",level:3},{value:"Label-Based Routing",id:"label-based-routing",level:3},{value:"Supported Operations",id:"supported-operations",level:2},{value:"System Operations (Query)",id:"system-operations-query",level:3},{value:"Network Operations",id:"network-operations",level:3},{value:"Provider Mapping",id:"provider-mapping",level:3},{value:"Operation Type Definitions",id:"operation-type-definitions",level:3},{value:"Job Lifecycle",id:"job-lifecycle",level:2},{value:"1. Job Submission",id:"1-job-submission",level:3},{value:"2. Job States",id:"2-job-states",level:3},{value:"3. Job Polling",id:"3-job-polling",level:3},{value:"Queue Statistics",id:"queue-statistics",level:3},{value:"Worker Implementation",id:"worker-implementation",level:2},{value:"Processing Flow",id:"processing-flow",level:3},{value:"Append-Only Status Architecture",id:"append-only-status-architecture",level:3},{value:"Multi-Host Job Processing",id:"multi-host-job-processing",level:3},{value:"Worker Subscription Patterns",id:"worker-subscription-patterns",level:3},{value:"Provider Pattern",id:"provider-pattern",level:3},{value:"Operation Examples",id:"operation-examples",level:2},{value:"System Operations",id:"system-operations",level:3},{value:"Network Operations",id:"network-operations-1",level:3},{value:"REST API Integration",id:"rest-api-integration",level:2},{value:"Job Creation Endpoint",id:"job-creation-endpoint",level:3},{value:"Job Retry Endpoint",id:"job-retry-endpoint",level:3},{value:"Job Status Endpoint",id:"job-status-endpoint",level:3},{value:"CLI Commands",id:"cli-commands",level:2},{value:"Job Management",id:"job-management",level:3},{value:"Package Architecture",id:"package-architecture",level:2},{value:"Separation of Concerns",id:"separation-of-concerns",level:3},{value:"Architectural Benefits",id:"architectural-benefits",level:2},{value:"Race Condition Elimination",id:"race-condition-elimination",level:3},{value:"Multi-Host Distributed Processing",id:"multi-host-distributed-processing",level:3},{value:"Observability &amp; Debugging",id:"observability--debugging",level:3},{value:"Direct Worker Testing",id:"direct-worker-testing",level:3},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Performance Optimizations",id:"performance-optimizations",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Monitoring",id:"monitoring",level:2},{value:"Migration Path",id:"migration-path",level:2},{value:"Future Enhancements",id:"future-enhancements",level:2}];function a(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"job-system-architecture",children:"Job System Architecture"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Date:"})," June 2025 ",(0,r.jsx)(n.strong,{children:"Status:"})," Implemented ",(0,r.jsx)(n.strong,{children:"Author:"})," @retr0h"]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.p,{children:["The OSAPI Job System implements a ",(0,r.jsx)(n.strong,{children:"KV-first, stream-notification architecture"}),"\nusing NATS JetStream for distributed job processing. This system provides\nasynchronous operation execution with persistent job state, intelligent worker\nrouting, and comprehensive job lifecycle management."]}),"\n",(0,r.jsx)(n.h2,{id:"architecture-principles",children:"Architecture Principles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"KV-First Storage"}),": Job state lives in NATS KV for persistence and direct\naccess"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Stream Notifications"}),": Workers receive job notifications via JetStream\nsubjects"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Hierarchical Routing"}),": Operations use dot-notation for intelligent worker\ntargeting"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"REST-Compatible"}),": Supports standard HTTP polling patterns for API\nintegration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"CLI Management"}),": Direct job queue inspection and management tools"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"system-components",children:"System Components"}),"\n",(0,r.jsx)(n.h3,{id:"core-components",children:"Core Components"}),"\n",(0,r.jsx)(n.p,{children:"The system has three entry points that all funnel through a shared client layer\ninto NATS JetStream:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"REST API"})," \u2014 Creates jobs, queries status, returns results"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Jobs CLI"})," \u2014 Adds jobs, lists/inspects queue, monitors status"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Workers"})," \u2014 Processes jobs, updates status, stores results"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["All three use the ",(0,r.jsx)(n.strong,{children:"Job Client Layer"})," (",(0,r.jsx)(n.code,{children:"internal/job/client/"}),"), which provides\ntype-safe business logic operations (",(0,r.jsx)(n.code,{children:"CreateJob"}),", ",(0,r.jsx)(n.code,{children:"GetQueueStats"}),",\n",(0,r.jsx)(n.code,{children:"GetJobStatus"}),", ",(0,r.jsx)(n.code,{children:"ListJobs"}),") on top of NATS JetStream."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"NATS JetStream"})," provides three storage backends:"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Store"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["KV ",(0,r.jsx)(n.code,{children:"job-queue"})]}),(0,r.jsx)(n.td,{children:"Job persistence (immutable job definitions + status events)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["Stream ",(0,r.jsx)(n.code,{children:"JOBS"})]}),(0,r.jsx)(n.td,{children:"Worker notifications (subject-routed job IDs)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsxs)(n.td,{children:["KV ",(0,r.jsx)(n.code,{children:"job-responses"})]}),(0,r.jsx)(n.td,{children:"Result storage (worker responses keyed by request ID)"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"job-flow",children:"Job Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph LR\n    A["API / CLI"] --\x3e|1. create| JC["Job Client"]\n    JC --\x3e|store job| KV["KV job-queue"]\n    JC --\x3e|publish notification| Stream["JOBS Stream"]\n    Stream --\x3e|deliver| Worker\n    Worker --\x3e|fetch job| KV\n    Worker --\x3e|execute| Provider\n    Worker --\x3e|write result| KVR["KV job-responses"]\n    A --\x3e|3. poll status| KV\n    A --\x3e|3. read result| KVR'}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Creation"})," \u2014 API/CLI calls Job Client, which stores the job in KV and\npublishes a notification to the stream"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Processing"})," \u2014 Worker receives notification from the stream, fetches\nthe immutable job from KV, writes status events, executes the operation, and\nstores the result in KV"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Status Query"})," \u2014 API/CLI reads computed status from KV events"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"nats-configuration",children:"NATS Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"kv-buckets",children:"KV Buckets"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"job-queue"}),": Primary job storage"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Key format: ",(0,r.jsx)(n.code,{children:"{status}.{uuid}"})]}),"\n",(0,r.jsxs)(n.li,{children:["Status prefixes: ",(0,r.jsx)(n.code,{children:"unprocessed"}),", ",(0,r.jsx)(n.code,{children:"processing"}),", ",(0,r.jsx)(n.code,{children:"completed"}),", ",(0,r.jsx)(n.code,{children:"failed"})]}),"\n",(0,r.jsx)(n.li,{children:"TTL: 24 hours for completed/failed jobs"}),"\n",(0,r.jsx)(n.li,{children:"History: 5 versions"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"job-responses"}),": Result storage"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Key format: ",(0,r.jsx)(n.code,{children:"{sanitized_request_id}"})]}),"\n",(0,r.jsx)(n.li,{children:"TTL: 24 hours"}),"\n",(0,r.jsx)(n.li,{children:"Used for worker-to-client result passing"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"jetstream-configuration",children:"JetStream Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"Stream: JOBS\nSubjects:\n  - jobs.query.> # Read operations\n  - jobs.modify.> # Write operations\n\nConsumer: jobs-worker\nDurable: true\nAckPolicy: Explicit\nMaxDeliver: 3\nAckWait: 30s\n"})}),"\n",(0,r.jsx)(n.h2,{id:"subject-hierarchy",children:"Subject Hierarchy"}),"\n",(0,r.jsx)(n.p,{children:"The system uses structured subjects for efficient routing:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"jobs.{type}.{routing_type}.{value...}\n\nExamples:\n- jobs.query._any                  \u2014 load-balanced\n- jobs.query._all                  \u2014 broadcast all\n- jobs.query.host.server1          \u2014 direct to host\n- jobs.query.label.group.web       \u2014 label group (role level)\n- jobs.query.label.group.web.dev   \u2014 label group (role+env level)\n- jobs.modify._all                 \u2014 broadcast modify\n- jobs.modify.label.group.web      \u2014 label group modify\n"})}),"\n",(0,r.jsx)(n.h3,{id:"semantic-routing-rules",children:"Semantic Routing Rules"}),"\n",(0,r.jsx)(n.p,{children:"Operations are automatically routed to query or modify subjects based on their\ntype suffix:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Query operations"})," (read-only) \u2192 ",(0,r.jsx)(n.code,{children:"jobs.query.{target}"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".get"})," - Retrieve current state"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".query"})," - Query information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".read"})," - Read configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".status"})," - Get status information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".do"})," - Perform read-only actions (e.g., ping)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"system.*"})," - All system operations are read-only"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Modify operations"})," (state-changing) \u2192 ",(0,r.jsx)(n.code,{children:"jobs.modify.{target}"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".update"})," - Update configuration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".set"})," - Set new values"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".create"})," - Create resources"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".delete"})," - Remove resources"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:".execute"})," - Execute commands"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The operation details (category, operation, data) are specified in the JSON\npayload, not the subject."}),"\n",(0,r.jsx)(n.h3,{id:"target-types",children:"Target Types"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"_any"}),": Route to any available worker (load-balanced via queue group)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"_all"}),": Route to all workers (broadcast)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{hostname}"}),": Route to a specific worker (e.g., ",(0,r.jsx)(n.code,{children:"server1"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"{key}:{value}"}),": Route to all workers with a matching label (e.g.,\n",(0,r.jsx)(n.code,{children:"group:web"}),"). Label targets use broadcast semantics \u2014 all matching workers\nreceive the message. Values can be hierarchical with dot separators for prefix\nmatching (e.g., ",(0,r.jsx)(n.code,{children:"group:web.dev"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"label-based-routing",children:"Label-Based Routing"}),"\n",(0,r.jsx)(n.p,{children:"Workers can be configured with hierarchical labels for group targeting. Label\nvalues use dot-separated segments, and workers automatically subscribe to every\nprefix level:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"job:\n  worker:\n    hostname: web-01\n    labels:\n      group: web.dev.us-east\n"})}),"\n",(0,r.jsx)(n.p,{children:"A worker with the above config subscribes to these NATS subjects:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"jobs.*.host.web-01                     \u2014 direct\njobs.*._any                            \u2014 load-balanced (queue group)\njobs.*._all                            \u2014 broadcast\njobs.*.label.group.web                 \u2014 prefix: role level\njobs.*.label.group.web.dev             \u2014 prefix: role+env level\njobs.*.label.group.web.dev.us-east     \u2014 prefix: exact match\n"})}),"\n",(0,r.jsx)(n.p,{children:"Targeting examples:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"--target group:web                  # all web servers\n--target group:web.dev              # all web servers in dev\n--target group:web.dev.us-east      # exact match\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The dimension order in the label value determines the targeting hierarchy. Place\nthe most commonly targeted broad dimension first (e.g., role before env before\nregion). Label subscriptions have ",(0,r.jsx)(n.strong,{children:"no queue group"})," \u2014 all matching workers\nreceive the message (broadcast within the label group). Label keys must match\n",(0,r.jsx)(n.code,{children:"[a-zA-Z0-9_-]+"}),", and each dot-separated segment of the value must match the\nsame pattern."]}),"\n",(0,r.jsx)(n.h2,{id:"supported-operations",children:"Supported Operations"}),"\n",(0,r.jsx)(n.h3,{id:"system-operations-query",children:"System Operations (Query)"}),"\n",(0,r.jsxs)(n.p,{children:["All system operations are routed to ",(0,r.jsx)(n.code,{children:"jobs.query.*"})," subjects:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.hostname.get"})})," - Get system hostname"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.status.get"})})," - Get comprehensive system status (all providers)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.uptime.get"})})," - Get system uptime"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.os.get"})})," - Get operating system information"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.disk.get"})})," - Get disk usage statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.memory.get"})})," - Get memory statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"system.load.get"})})," - Get load average statistics"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"network-operations",children:"Network Operations"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Query/Action Operations"})," (",(0,r.jsx)(n.code,{children:"jobs.query.*"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"network.dns.get"})})," - Get DNS configuration for interface"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"network.ping.do"})})," - Execute ping to target address"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Modify Operations"})," (",(0,r.jsx)(n.code,{children:"jobs.modify.*"}),"):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"network.dns.update"})})," - Update DNS servers and search domains"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"provider-mapping",children:"Provider Mapping"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System Host"}),": hostname, uptime, OS info"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System Disk"}),": disk usage statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System Memory"}),": memory usage statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"System Load"}),": load average statistics"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Network DNS"}),": DNS configuration (get/update)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Network Ping"}),": ping execution and statistics"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"operation-type-definitions",children:"Operation Type Definitions"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// System operations - read-only\nconst (\n    OperationSystemHostnameGet = "system.hostname.get"\n    OperationSystemStatusGet   = "system.status.get"\n    OperationSystemUptimeGet   = "system.uptime.get"\n    OperationSystemLoadGet     = "system.load.get"\n    OperationSystemMemoryGet   = "system.memory.get"\n    OperationSystemDiskGet     = "system.disk.get"\n)\n\n// Network operations\nconst (\n    OperationNetworkDNSGet      = "network.dns.get"\n    OperationNetworkDNSUpdate   = "network.dns.update"\n    OperationNetworkPingExecute = "network.ping.execute"\n)\n\n// System operations - state-changing\nconst (\n    OperationSystemShutdown = "system.shutdown.execute"\n    OperationSystemReboot   = "system.reboot.execute"\n)\n'})}),"\n",(0,r.jsx)(n.h2,{id:"job-lifecycle",children:"Job Lifecycle"}),"\n",(0,r.jsx)(n.h3,{id:"1-job-submission",children:"1. Job Submission"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// Via API\nPOST /api/v1/jobs\n{\n  "operation": {\n    "type": "network.dns.get",\n    "data": {"interface": "eth0"}\n  },\n  "target_hostname": "_any"\n}\n\n// Via CLI\nosapi client job add --json-file dns-query.json --target-hostname _any\n'})}),"\n",(0,r.jsx)(n.h3,{id:"2-job-states",children:"2. Job States"}),"\n",(0,r.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e submitted\n    submitted --\x3e acknowledged\n    acknowledged --\x3e started\n    started --\x3e completed\n    started --\x3e failed"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"State Transitions via Events:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"submitted"}),": Job created by API/CLI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"acknowledged"}),": Worker receives job notification"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"started"}),": Worker begins processing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"completed"}),": Worker finishes successfully"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"failed"}),": Worker encounters error"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Multi-Worker States:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"processing"}),": One or more workers are active"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"partial_failure"}),": Some workers completed, others failed"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"completed"}),": All workers finished successfully"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"failed"}),": All workers failed"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"3-job-polling",children:"3. Job Polling"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// REST API polling\nGET /api/v1/jobs/{job-id}\n\n// Returns (computed from events)\n{\n  "id": "550e8400-e29b-41d4-a716-446655440000",\n  "status": "completed",\n  "created": "2024-01-10T10:00:00Z",\n  "hostname": "worker-node-1",\n  "updated_at": "2024-01-10T10:05:30Z",\n  "operation": {...},\n  "result": {...}\n}\n\n// For multi-worker jobs (_all targeting)\n{\n  "id": "550e8400-e29b-41d4-a716-446655440000",\n  "status": "partial_failure",\n  "created": "2024-01-10T10:00:00Z",\n  "hostname": "worker-node-2", // Last responding worker\n  "updated_at": "2024-01-10T10:05:45Z",\n  "error": "disk full on worker-node-3",\n  "operation": {...}\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Status is computed in real-time from:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Immutable job data (",(0,r.jsx)(n.code,{children:"jobs.{id}"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Status events (",(0,r.jsx)(n.code,{children:"status.{id}.*"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Worker responses (",(0,r.jsx)(n.code,{children:"responses.{id}.*"}),")"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"queue-statistics",children:"Queue Statistics"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "total_jobs": 42,\n  "status_counts": {\n    "unprocessed": 5,\n    "processing": 2,\n    "completed": 30,\n    "failed": 5\n  },\n  "operation_counts": {\n    "system.hostname.get": 15,\n    "system.status.get": 19,\n    "network.dns.get": 8,\n    "network.ping.do": 23\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"worker-implementation",children:"Worker Implementation"}),"\n",(0,r.jsx)(n.h3,{id:"processing-flow",children:"Processing Flow"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant JS as JetStream\n    participant Worker\n    participant KV as KV job-queue\n    participant Provider\n    participant KVR as KV job-responses\n\n    JS->>Worker: deliver notification\n    Worker->>KV: fetch immutable job\n    Worker->>KV: write status: acknowledged\n    Worker->>KV: write status: started\n    Worker->>Provider: execute operation\n    Provider--\x3e>Worker: result\n    Worker->>KV: write status: completed/failed\n    Worker->>KVR: store response\n    Worker->>JS: ACK message"}),"\n",(0,r.jsx)(n.h3,{id:"append-only-status-architecture",children:"Append-Only Status Architecture"}),"\n",(0,r.jsxs)(n.p,{children:["The job system uses an ",(0,r.jsx)(n.strong,{children:"append-only status log"})," to eliminate race conditions\nand provide complete audit trails:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Key Structure:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"jobs.{job-id}                               # Immutable job definition\nstatus.{job-id}.{event}.{hostname}.{nano}   # Append-only status events\nresponses.{job-id}.{hostname}.{nano}        # Worker responses\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Status Event Timeline:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"status.abc123.submitted._api.1640995200         # Job created by API\nstatus.abc123.acknowledged.server1.1640995201   # Server1 receives job\nstatus.abc123.acknowledged.server2.1640995202   # Server2 receives job\nstatus.abc123.started.server1.1640995205        # Server1 begins processing\nstatus.abc123.started.server2.1640995207        # Server2 begins processing\nstatus.abc123.completed.server1.1640995210      # Server1 finishes\nstatus.abc123.failed.server2.1640995215         # Server2 fails\n"})}),"\n",(0,r.jsx)(n.h3,{id:"multi-host-job-processing",children:"Multi-Host Job Processing"}),"\n",(0,r.jsx)(n.p,{children:"The append-only architecture enables true broadcast job processing:"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["For ",(0,r.jsx)(n.code,{children:"_any"})," jobs"]})," (load balancing):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Multiple workers can acknowledge the job"}),"\n",(0,r.jsx)(n.li,{children:"First to start wins, others see it's being processed"}),"\n",(0,r.jsx)(n.li,{children:"Automatic failover if processing worker fails"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["For ",(0,r.jsx)(n.code,{children:"_all"})," jobs"]})," (broadcast):"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All targeted workers process the same immutable job"}),"\n",(0,r.jsx)(n.li,{children:"Each worker writes independent status events"}),"\n",(0,r.jsx)(n.li,{children:"No race conditions or key conflicts"}),"\n",(0,r.jsx)(n.li,{children:"Complete tracking of which hosts responded"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Status Computation:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Job status is computed from events in real-time"}),"\n",(0,r.jsxs)(n.li,{children:["Supports rich states: ",(0,r.jsx)(n.code,{children:"submitted"}),", ",(0,r.jsx)(n.code,{children:"processing"}),", ",(0,r.jsx)(n.code,{children:"completed"}),", ",(0,r.jsx)(n.code,{children:"failed"}),",\n",(0,r.jsx)(n.code,{children:"partial_failure"})]}),"\n",(0,r.jsx)(n.li,{children:"Client aggregates worker states to determine overall status"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"worker-subscription-patterns",children:"Worker Subscription Patterns"}),"\n",(0,r.jsx)(n.p,{children:"Each worker creates JetStream consumers with these filter subjects:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Load-balanced"})," (queue group): ",(0,r.jsx)(n.code,{children:"jobs.query._any"}),", ",(0,r.jsx)(n.code,{children:"jobs.modify._any"})," \u2014 only\none worker in the queue group processes each message"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Direct"}),": ",(0,r.jsx)(n.code,{children:"jobs.query.host.{hostname}"}),", ",(0,r.jsx)(n.code,{children:"jobs.modify.host.{hostname}"})," \u2014\nmessages addressed to this specific worker"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Broadcast"}),": ",(0,r.jsx)(n.code,{children:"jobs.query._all"}),", ",(0,r.jsx)(n.code,{children:"jobs.modify._all"})," \u2014 all workers receive the\nmessage (no queue group)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Label"})," (per prefix level, no queue group):\n",(0,r.jsx)(n.code,{children:"jobs.query.label.{key}.{prefix}"}),", ",(0,r.jsx)(n.code,{children:"jobs.modify.label.{key}.{prefix}"})," \u2014 all\nworkers matching the label prefix receive the message"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"provider-pattern",children:"Provider Pattern"}),"\n",(0,r.jsx)(n.p,{children:"Workers use platform-specific providers:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// Provider selection based on platform\nswitch platform {\ncase "ubuntu":\n    provider = dns.NewUbuntuProvider()\ndefault:\n    provider = dns.NewLinuxProvider()\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"operation-examples",children:"Operation Examples"}),"\n",(0,r.jsx)(n.h3,{id:"system-operations",children:"System Operations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// Get hostname\n{\n  "type": "system.hostname.get",\n  "data": {}\n}\n\n// Get system status\n{\n  "type": "system.status.get",\n  "data": {}\n}\n\n// Get uptime\n{\n  "type": "system.uptime.get",\n  "data": {}\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"network-operations-1",children:"Network Operations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'// Query DNS configuration\n{\n  "type": "network.dns.get",\n  "data": {"interface": "eth0"}\n}\n\n// Update DNS servers\n{\n  "type": "network.dns.update",\n  "data": {\n    "servers": ["8.8.8.8", "1.1.1.1"],\n    "interface": "eth0"\n  }\n}\n\n// Execute ping\n{\n  "type": "network.ping.do",\n  "data": {\n    "address": "google.com"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"rest-api-integration",children:"REST API Integration"}),"\n",(0,r.jsx)(n.h3,{id:"job-creation-endpoint",children:"Job Creation Endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'POST /api/jobs\nContent-Type: application/json\n\n{\n  "type": "system.hostname.get",\n  "data": {},\n  "target_hostname": "_any"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "job_id": "uuid-12345",\n  "status": "created",\n  "revision": 1\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"job-retry-endpoint",children:"Job Retry Endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:'POST /api/jobs/{job_id}/retry\nContent-Type: application/json\n\n{\n  "target_hostname": "_any"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "job_id": "uuid-67890",\n  "status": "created",\n  "revision": 1\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"job-status-endpoint",children:"Job Status Endpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-http",children:"GET /api/jobs/{job_id}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response (Processing):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "job_id": "uuid-12345",\n  "status": "processing",\n  "created": "2025-06-14T10:00:00Z",\n  "operation": {\n    "type": "system.hostname.get",\n    "data": {}\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Response (Completed):"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "job_id": "uuid-12345",\n  "status": "completed",\n  "created": "2025-06-14T10:00:00Z",\n  "operation": {\n    "type": "system.hostname.get",\n    "data": {}\n  },\n  "result": {\n    "hostname": "server-01"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"cli-commands",children:"CLI Commands"}),"\n",(0,r.jsx)(n.h3,{id:"job-management",children:"Job Management"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Add a job\nosapi client job add --json-file operation.json --target-hostname _any\n\n# List jobs\nosapi client job list --status unprocessed --limit 10\n\n# Get job details\nosapi client job get --job-id 550e8400-e29b-41d4-a716-446655440000\n\n# Run job and wait for completion\nosapi client job run --json-file operation.json --timeout 60\n\n# Monitor queue status\nosapi client job status --poll-interval-seconds 5\n\n# Delete a job\nosapi client job delete --job-id uuid-12345\n\n# Retry a failed/stuck job\nosapi client job retry --job-id 550e8400-...\n"})}),"\n",(0,r.jsx)(n.h2,{id:"package-architecture",children:"Package Architecture"}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"internal/job/"})," package contains shared domain types and two subpackages:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Root (",(0,r.jsx)(n.code,{children:"internal/job/"}),"):"]})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"File"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"types.go"})}),(0,r.jsx)(n.td,{children:"Core domain types (Request, Response, QueuedJob, QueueStats, WorkerState, TimelineEvent)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"subjects.go"})}),(0,r.jsx)(n.td,{children:"Subject routing, target parsing, label validation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"hostname.go"})}),(0,r.jsx)(n.td,{children:"Local hostname resolution and caching"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"config.go"})}),(0,r.jsx)(n.td,{children:"Configuration structures"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Client (",(0,r.jsx)(n.code,{children:"internal/job/client/"}),"):"]})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"File"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"client.go"})}),(0,r.jsx)(n.td,{children:"Publish-and-wait/collect with KV + stream"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"query.go"})}),(0,r.jsx)(n.td,{children:"Query operations (system status, hostname, etc.)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"modify.go"})}),(0,r.jsx)(n.td,{children:"Modify operations (DNS updates)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"jobs.go"})}),(0,r.jsx)(n.td,{children:"CreateJob, RetryJob, GetJobStatus, GetQueueStats"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"worker.go"})}),(0,r.jsx)(n.td,{children:"WriteStatusEvent, WriteJobResponse"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"types.go"})}),(0,r.jsx)(n.td,{children:"Client-specific types and interfaces"})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Worker (",(0,r.jsx)(n.code,{children:"internal/job/worker/"}),"):"]})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"File"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"worker.go"})}),(0,r.jsx)(n.td,{children:"Worker implementation and lifecycle management"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"server.go"})}),(0,r.jsx)(n.td,{children:"Worker server (NATS connect, stream setup, run)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"consumer.go"})}),(0,r.jsx)(n.td,{children:"JetStream consumer creation and subscription"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"handler.go"})}),(0,r.jsx)(n.td,{children:"Job lifecycle handling with status events"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"processor.go"})}),(0,r.jsx)(n.td,{children:"Provider dispatch and execution"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"factory.go"})}),(0,r.jsx)(n.td,{children:"Worker creation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"types.go"})}),(0,r.jsx)(n.td,{children:"Worker-specific types and context"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"separation-of-concerns",children:"Separation of Concerns"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"internal/job/"})}),": Core domain types shared across all components"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"internal/job/client/"})}),": High-level operations for API integration"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"internal/job/worker/"})}),": Job processing and worker lifecycle management"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"No type duplication"}),": All packages use shared types from main job package"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"architectural-benefits",children:"Architectural Benefits"}),"\n",(0,r.jsx)(n.h3,{id:"race-condition-elimination",children:"Race Condition Elimination"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Previous Issues:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Multiple workers updating same job key simultaneously"}),"\n",(0,r.jsx)(n.li,{children:"Status transitions conflicting between workers"}),"\n",(0,r.jsx)(n.li,{children:"Response overwrites in multi-host scenarios"}),"\n",(0,r.jsx)(n.li,{children:"Timing issues with job state management"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Solution:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Immutable jobs"}),": Never modified after creation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Unique event keys"}),": Each event has nanosecond timestamp"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Append-only writes"}),": No conflicts, ever"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Computed status"}),": Derived from events, not stored"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"multi-host-distributed-processing",children:"Multi-Host Distributed Processing"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Supports True Broadcast:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Send DNS update to ALL servers\nosapi client job add --target-hostname _all --json-file dns-update.json\n\n# Results: Each server processes independently\n# - server1: completed (2.1s)\n# - server2: completed (1.8s)\n# - server3: failed (disk full)\n# Overall status: partial_failure\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Load Balancing with Failover:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Send to ANY available server\nosapi client job add --target-hostname _any --json-file system-check.json\n\n# Results: First available worker processes\n# Automatic failover if worker fails\n"})}),"\n",(0,r.jsx)(n.h3,{id:"observability--debugging",children:"Observability & Debugging"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Complete Event Timeline:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"See exactly when each worker received job"}),"\n",(0,r.jsx)(n.li,{children:"Track processing duration per worker"}),"\n",(0,r.jsx)(n.li,{children:"Identify bottlenecks and failures"}),"\n",(0,r.jsx)(n.li,{children:"Historical audit trail for compliance"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"direct-worker-testing",children:"Direct Worker Testing"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Start a worker\nosapi worker start\n\n# Worker will:\n# - Connect to NATS\n# - Subscribe to job streams\n# - Process jobs based on platform capabilities\n"})}),"\n",(0,r.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authentication"}),": NATS authentication via environment variables"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Authorization"}),": Subject-based permissions for workers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Input Validation"}),": All job data validated before processing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Result Sanitization"}),": Sensitive data filtered from responses"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"performance-optimizations",children:"Performance Optimizations"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Batch Operations"}),": Workers can fetch multiple jobs per poll"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Connection Pooling"}),": Reuse NATS connections"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"KV Caching"}),": Local caching of frequently accessed jobs"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Stream Filtering"}),": Workers only receive relevant job types"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Efficient Filtering"}),": Status-based key prefixes enable fast queries"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Retry Logic"}),": Failed jobs retry up to MaxDeliver times"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dead Letter Queue"}),": Jobs failing after max retries"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Timeout Handling"}),": Jobs timeout after AckWait period"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Graceful Degradation"}),": Workers continue on provider errors"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,r.jsx)(n.p,{children:"Key metrics to track:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Queue depth by status"}),"\n",(0,r.jsx)(n.li,{children:"Job processing time"}),"\n",(0,r.jsx)(n.li,{children:"Worker availability"}),"\n",(0,r.jsx)(n.li,{children:"DLQ message count"}),"\n",(0,r.jsx)(n.li,{children:"Stream consumer lag"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"migration-path",children:"Migration Path"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 1"}),": Deploy job system alongside existing task system ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 2"}),": Implement job client abstraction layer ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 3"}),": Integrate job client into REST API ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 4"}),": Migrate all endpoints to strict-server + job client ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 5"}),": Delete legacy task system ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Phase 6"}),": Consistency pass and test coverage audit ",(0,r.jsx)(n.em,{children:"(Complete)"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"future-enhancements",children:"Future Enhancements"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Dependencies"}),": Chain multiple operations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Scheduled Jobs"}),": Cron-like job scheduling"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Priorities"}),": High/medium/low priority queues"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Result Streaming"}),": Stream large results via NATS"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Worker Autoscaling"}),": Dynamic worker pool sizing"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Job Cancellation"}),": Ability to cancel running jobs"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>o,x:()=>l});var r=s(96540);const i={},t=r.createContext(i);function o(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);