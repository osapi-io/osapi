"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9866],{89059(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var t=s(74848),r=s(28453);const i={date:new Date("2026-02-20T00:00:00.000Z")},d=void 0,o={id:"sidebar/development/tasks/sessions/2026-02-20",title:"2026-02-20",description:"Summary",source:"@site/docs/sidebar/development/tasks/sessions/2026-02-20.md",sourceDirName:"sidebar/development/tasks/sessions",slug:"/sidebar/development/tasks/sessions/2026-02-20",permalink:"/osapi/sidebar/development/tasks/sessions/2026-02-20",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{date:"2026-02-20T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"2026-02-17",permalink:"/osapi/sidebar/development/tasks/sessions/2026-02-17"},next:{title:"2026-02-27",permalink:"/osapi/sidebar/development/tasks/sessions/2026-02-27"}},c={},l=[{value:"Summary",id:"summary",level:2},{value:"Changes",id:"changes",level:2},{value:"Decisions",id:"decisions",level:2},{value:"Next Steps",id:"next-steps",level:2}];function a(e){const n={code:"code",h2:"h2",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsx)(n.p,{children:"Implemented distributed tracing with OpenTelemetry across all OSAPI components\n(CLI, API server, worker)."}),"\n",(0,t.jsx)(n.h2,{id:"changes",children:"Changes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"go.mod"})," / ",(0,t.jsx)(n.code,{children:"go.sum"})," \u2014 Added OTel SDK, exporters, otelecho middleware"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/config/types.go"})," \u2014 Added ",(0,t.jsx)(n.code,{children:"Telemetry"})," and ",(0,t.jsx)(n.code,{children:"TracingConfig"})," structs"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"osapi.yaml"})," \u2014 Added ",(0,t.jsx)(n.code,{children:"telemetry.tracing"})," section"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/telemetry/telemetry.go"})," \u2014 NEW: Tracer provider initialization\n(stdout, OTLP, noop)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/telemetry/propagation.go"})," \u2014 NEW: KV map inject/extract for trace\ncontext"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/telemetry/slog.go"})," \u2014 NEW: slog handler wrapper that adds\ntrace_id/span_id"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/telemetry/*_public_test.go"})," \u2014 NEW: 8 tests covering all telemetry\nfunctionality"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/api/server.go"})," \u2014 Added ",(0,t.jsx)(n.code,{children:'otelecho.Middleware("osapi-api")'})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/client/client.go"})," \u2014 Inject traceparent into HTTP headers"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/worker/consumer.go"})," \u2014 Copy NATS message headers from\n",(0,t.jsx)(n.code,{children:"jetstream.Msg"})," to ",(0,t.jsx)(n.code,{children:"*nats.Msg"})," in ",(0,t.jsx)(n.code,{children:"handleJobMessageJS"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/worker/handler.go"})," \u2014 Extract trace context from NATS message\nheaders, create ",(0,t.jsx)(n.code,{children:"job.process"})," span with attributes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/worker/handler_test.go"})," \u2014 Updated writeStatusEvent calls with\ncontext parameter"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/root.go"})," \u2014 Debug auto-enable, slog trace wrapper"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/api_server_start.go"})," \u2014 Init tracer provider with shutdown"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/job_worker_start.go"})," \u2014 Init tracer provider with shutdown"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"cmd/client.go"})," \u2014 Init tracer in PersistentPreRun, shutdown in\nPersistentPostRun"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"docs/docs/sidebar/configuration.md"})," \u2014 Documented telemetry config"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"decisions",children:"Decisions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Initially propagated trace context through KV job data map, then moved to NATS\nmessage headers for cleaner separation (trace context is transport metadata,\nnot business data)."}),"\n",(0,t.jsxs)(n.li,{children:["nats-client ",(0,t.jsx)(n.code,{children:"Publish"})," transparently injects OTel trace context \u2014 callers just\npass ",(0,t.jsx)(n.code,{children:"ctx"}),", no manual header management needed."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ExtractTraceContextFromHeader"})," normalizes header keys before extraction. NATS\nJetStream delivers headers with non-canonical casing (lowercase ",(0,t.jsx)(n.code,{children:"traceparent"}),"\ninstead of ",(0,t.jsx)(n.code,{children:"Traceparent"}),"), which breaks ",(0,t.jsx)(n.code,{children:"http.Header.Get"})," lookups that depend\non canonical MIME keys."]}),"\n",(0,t.jsx)(n.li,{children:"Used a lightweight custom slog handler instead of the otelslog bridge to avoid\nan additional dependency and keep control over attribute naming."}),"\n",(0,t.jsxs)(n.li,{children:["Auto-enable stdout tracing when ",(0,t.jsx)(n.code,{children:"--debug"})," is set for zero-config development\nexperience."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Remove ",(0,t.jsx)(n.code,{children:"replace"})," directive in ",(0,t.jsx)(n.code,{children:"go.mod"})," once nats-client with OTel support is\npublished."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>d,x:()=>o});var t=s(96540);const r={},i=t.createContext(r);function d(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);