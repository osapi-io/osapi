"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8480],{63794(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});var i=s(74848),c=s(28453);const r={title:"Add NATS authentication and namespace support to config",status:"done",created:new Date("2026-02-20T00:00:00.000Z"),updated:new Date("2026-02-21T00:00:00.000Z")},d=void 0,t={id:"sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces",title:"Add NATS authentication and namespace support to config",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Add NATS authentication and namespace support to config",status:"done",created:"2026-02-20T00:00:00.000Z",updated:"2026-02-21T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"HTTP metrics with Prometheus endpoint",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint"},next:{title:"Refactor NATS config so each consumer owns its connection settings",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-refactor-nats-config"}},o={},l=[{value:"Objective",id:"objective",level:2},{value:"Outcome",id:"outcome",level:2},{value:"Config restructure",id:"config-restructure",level:3},{value:"Auth support",id:"auth-support",level:3},{value:"Namespace support",id:"namespace-support",level:3},{value:"Files changed",id:"files-changed",level:3}];function a(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,i.jsxs)(n.p,{children:["The nats-client library already supports three auth types (NoAuth, UserPass,\nNKey), but OSAPI hardcoded ",(0,i.jsx)(n.code,{children:"NoAuth"})," in all three components. Surface these auth\noptions through ",(0,i.jsx)(n.code,{children:"osapi.yaml"})," and plumb them into the client connections. Also\nadd namespace/subject prefix support so multiple OSAPI deployments can share a\nNATS cluster without colliding."]}),"\n",(0,i.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,i.jsx)(n.p,{children:"Implemented full NATS auth and namespace support across all three components:"}),"\n",(0,i.jsx)(n.h3,{id:"config-restructure",children:"Config restructure"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Moved JetStream infrastructure config (",(0,i.jsx)(n.code,{children:"stream"}),", ",(0,i.jsx)(n.code,{children:"kv"}),", ",(0,i.jsx)(n.code,{children:"dlq"}),") from ",(0,i.jsx)(n.code,{children:"job.*"})," to\n",(0,i.jsx)(n.code,{children:"nats.*"})," \u2014 NATS owns infrastructure, job owns worker runtime"]}),"\n",(0,i.jsxs)(n.li,{children:["Moved consumer config from ",(0,i.jsx)(n.code,{children:"job.consumer"})," to ",(0,i.jsx)(n.code,{children:"job.worker.consumer"})]}),"\n",(0,i.jsxs)(n.li,{children:["Added ",(0,i.jsx)(n.code,{children:"namespace"})," and ",(0,i.jsx)(n.code,{children:"auth"})," fields to ",(0,i.jsx)(n.code,{children:"nats.server"}),", ",(0,i.jsx)(n.code,{children:"api.server.nats"}),", and\n",(0,i.jsx)(n.code,{children:"job.worker.nats"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"auth-support",children:"Auth support"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Added ",(0,i.jsx)(n.code,{children:"NATSAuth"})," (client-side) and ",(0,i.jsx)(n.code,{children:"NATSServerAuth"})," (server-side) config types\nsupporting ",(0,i.jsx)(n.code,{children:"none"}),", ",(0,i.jsx)(n.code,{children:"user_pass"}),", and ",(0,i.jsx)(n.code,{children:"nkey"})," auth"]}),"\n",(0,i.jsxs)(n.li,{children:["Created ",(0,i.jsx)(n.code,{children:"cmd/nats_auth.go"})," helper to bridge config types to nats-client\n",(0,i.jsx)(n.code,{children:"AuthOptions"})]}),"\n",(0,i.jsxs)(n.li,{children:["Server-side auth configures ",(0,i.jsx)(n.code,{children:"natsserver.Options.Users"})," / ",(0,i.jsx)(n.code,{children:".Nkeys"})]}),"\n",(0,i.jsxs)(n.li,{children:["Client-side auth passes credentials through ",(0,i.jsx)(n.code,{children:"natsclient.AuthOptions"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"namespace-support",children:"Namespace support"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"job.Init(namespace)"})," sets global ",(0,i.jsx)(n.code,{children:"JobsQueryPrefix"})," / ",(0,i.jsx)(n.code,{children:"JobsModifyPrefix"})," with\nnamespace prefix (e.g., ",(0,i.jsx)(n.code,{children:"osapi.jobs.query"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ApplyNamespaceToInfraName()"})," prefixes stream/KV names (e.g., ",(0,i.jsx)(n.code,{children:"osapi-JOBS"}),",\n",(0,i.jsx)(n.code,{children:"osapi-job-queue"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ApplyNamespaceToSubjects()"})," prefixes stream subjects (e.g., ",(0,i.jsx)(n.code,{children:"osapi.jobs.>"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ParseSubject()"})," handles namespace-prefixed subjects transparently"]}),"\n",(0,i.jsxs)(n.li,{children:["Worker uses namespaced ",(0,i.jsx)(n.code,{children:"streamName"})," passed at construction time"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"files-changed",children:"Files changed"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/config/types.go"})," \u2014 new auth/namespace/stream/kv/dlq types"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/subjects.go"})," \u2014 namespace Init, Apply helpers"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/config.go"})," \u2014 updated signatures to use new config types"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/worker/types.go"})," \u2014 added ",(0,i.jsx)(n.code,{children:"streamName"})," field"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/worker/worker.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"streamName"})," parameter in ",(0,i.jsx)(n.code,{children:"New()"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/worker/consumer.go"})," \u2014 uses ",(0,i.jsx)(n.code,{children:"w.streamName"}),", dynamic prefixes"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/worker/handler.go"})," \u2014 uses dynamic\n",(0,i.jsx)(n.code,{children:"JobsQueryPrefix"}),"/",(0,i.jsx)(n.code,{children:"JobsModifyPrefix"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/client/client.go"})," \u2014 ",(0,i.jsx)(n.code,{children:"StreamName"})," in Options"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"internal/job/client/jobs.go"})," \u2014 dynamic DLQ name from ",(0,i.jsx)(n.code,{children:"streamName"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/nats_auth.go"})," \u2014 new auth helper"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/nats_server_start.go"})," \u2014 server auth, namespace, inline infra setup"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/api_server_start.go"})," \u2014 client auth, namespace"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/job_worker_start.go"})," \u2014 client auth, namespace, pass streamName"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/nats_server.go"})," \u2014 debug logging for new fields"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/api_server.go"})," \u2014 debug logging for NATS connection"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cmd/job_worker.go"})," \u2014 debug logging, fixed viper bindings"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"configs/osapi.yaml"})," \u2014 restructured config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"configs/osapi.local.yaml"})," \u2014 restructured config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"configs/osapi.nerd.yaml"})," \u2014 restructured config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"test/osapi.yaml"})," \u2014 restructured config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"docs/docs/sidebar/configuration.md"})," \u2014 full rewrite with auth/namespace docs"]}),"\n",(0,i.jsx)(n.li,{children:"All test files updated for new config types and function signatures"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>d,x:()=>t});var i=s(96540);const c={},r=i.createContext(c);function d(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);