"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2363],{39018(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>a});var s=t(74848),r=t(28453);const i={title:"Fix trace context propagation from API server to worker via NATS",status:"done",created:new Date("2026-02-21T00:00:00.000Z"),updated:new Date("2026-02-21T00:00:00.000Z")},o=void 0,c={id:"sidebar/development/tasks/done/2026-02-21-fix-trace-propagation",title:"Fix trace context propagation from API server to worker via NATS",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-21-fix-trace-propagation.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-21-fix-trace-propagation",permalink:"/osapi/sidebar/development/tasks/done/2026-02-21-fix-trace-propagation",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Fix trace context propagation from API server to worker via NATS",status:"done",created:"2026-02-21T00:00:00.000Z",updated:"2026-02-21T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Surface failed worker responses in broadcast query results",permalink:"/osapi/sidebar/development/tasks/done/2026-02-21-fix-broadcast-silent-failures"},next:{title:"Backlog",permalink:"/osapi/category/backlog"}},d={},a=[{value:"Objective",id:"objective",level:2},{value:"Analysis",id:"analysis",level:2},{value:"Files Involved",id:"files-involved",level:2},{value:"Outcome",id:"outcome",level:2}];function l(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,s.jsx)(n.p,{children:"Trace IDs differ between the API server and worker for the same job, meaning\nOpenTelemetry trace context is not propagating through NATS JetStream message\nheaders. The worker creates a new root span instead of continuing the API\nserver's trace."}),"\n",(0,s.jsx)(n.h2,{id:"analysis",children:"Analysis"}),"\n",(0,s.jsx)(n.p,{children:"The code path looks correct on paper:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"otelecho.Middleware"})," creates span \u2192 context has trace_id"]}),"\n",(0,s.jsxs)(n.li,{children:["Handler passes ",(0,s.jsx)(n.code,{children:"ctx"})," through to ",(0,s.jsx)(n.code,{children:"publishAndWait"})," \u2192\n",(0,s.jsx)(n.code,{children:"natsClient.Publish(ctx, ...)"})]}),"\n",(0,s.jsxs)(n.li,{children:["nats-client ",(0,s.jsx)(n.code,{children:"Publish"})," injects via\n",(0,s.jsx)(n.code,{children:"otel.GetTextMapPropagator().Inject(ctx, HeaderCarrier(msg.Header))"})]}),"\n",(0,s.jsxs)(n.li,{children:["JetStream ",(0,s.jsx)(n.code,{children:"PublishMsg"})," sends message with headers"]}),"\n",(0,s.jsxs)(n.li,{children:["Worker receives message via ",(0,s.jsx)(n.code,{children:"consumer.Fetch"})," \u2192 ",(0,s.jsx)(n.code,{children:"msg.Headers()"})]}),"\n",(0,s.jsxs)(n.li,{children:["Worker calls\n",(0,s.jsx)(n.code,{children:"ExtractTraceContextFromHeader(context.Background(), http.Header(msg.Header))"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["OTel versions match (",(0,s.jsx)(n.code,{children:"v1.40.0"}),") in both main module and nats-client. Propagator\nis set before server starts. JetStream supports headers since NATS 2.2."]}),"\n",(0,s.jsxs)(n.p,{children:["The extraction silently falls back to ",(0,s.jsx)(n.code,{children:"context.Background()"})," when no valid trace\ncontext is found, causing the worker to create a new root span."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Root cause"}),": The nats-client version pinned in go.mod\n(",(0,s.jsx)(n.code,{children:"v0.0.0-20260215190839-25dd316864d1"}),") used ",(0,s.jsx)(n.code,{children:"ExtJS.Publish()"})," which does not\npass headers. The old ",(0,s.jsx)(n.code,{children:"Publish(ctx, subject, data)"})," method had no way to attach\nheaders to the message. The Feb 20 commit ",(0,s.jsx)(n.code,{children:"80144e1"})," in nats-client switched to\n",(0,s.jsx)(n.code,{children:"ExtJS.PublishMsg(ctx, msg)"})," with OTel trace context injected into NATS message\nheaders via ",(0,s.jsx)(n.code,{children:"otel.GetTextMapPropagator().Inject()"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"files-involved",children:"Files Involved"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Role"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"nats-client/pkg/client/jetstream.go:137-165"})}),(0,s.jsx)(n.td,{children:"Publish with header injection"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"internal/job/worker/handler.go:96"})}),(0,s.jsx)(n.td,{children:"Trace extraction from NATS headers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"internal/telemetry/propagation.go:105-115"})}),(0,s.jsx)(n.td,{children:"Header normalization + extraction"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"internal/job/worker/consumer.go:226-246"})}),(0,s.jsx)(n.td,{children:"JetStream \u2192 nats.Msg adapter"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"internal/job/client/client.go:137"})}),(0,s.jsx)(n.td,{children:"publishAndWait Publish call"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Fix"}),": Updated nats-client dependency to ",(0,s.jsx)(n.code,{children:"v0.0.0-20260221001231-80144e1c7d21"}),"\nvia ",(0,s.jsx)(n.code,{children:"go get github.com/osapi-io/nats-client@latest"}),". No code changes needed in\nosapi \u2014 the trace injection/extraction code paths were already correct."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Verification"}),": ",(0,s.jsx)(n.code,{children:"go build ./..."})," compiles, ",(0,s.jsx)(n.code,{children:"just go::unit"})," all tests pass."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},28453(e,n,t){t.d(n,{R:()=>o,x:()=>c});var s=t(96540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);