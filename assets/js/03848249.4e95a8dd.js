"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8079],{89401(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>c});var s=r(74848),i=r(28453);const t={sidebar_position:3},o="Job System",a={id:"sidebar/features/job-system",title:"Job System",description:"The job system is the backbone of OSAPI. Every state-reading or state-changing",source:"@site/docs/sidebar/features/job-system.md",sourceDirName:"sidebar/features",slug:"/sidebar/features/job-system",permalink:"/osapi/sidebar/features/job-system",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"testSidebar",previous:{title:"Command Execution",permalink:"/osapi/sidebar/features/command-execution"},next:{title:"Audit Logging",permalink:"/osapi/sidebar/features/audit-logging"}},d={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Job Routing",id:"job-routing",level:2},{value:"Job Lifecycle",id:"job-lifecycle",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Permissions",id:"permissions",level:2},{value:"Related",id:"related",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"job-system",children:"Job System"})}),"\n",(0,s.jsx)(n.p,{children:"The job system is the backbone of OSAPI. Every state-reading or state-changing\noperation runs as an asynchronous job, allowing the API server to remain\nunprivileged while workers execute operations on target hosts."}),"\n",(0,s.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,s.jsxs)(n.p,{children:["OSAPI uses a ",(0,s.jsx)(n.strong,{children:"KV-first, stream-notification"})," architecture built on NATS\nJetStream:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"The API server writes a job definition to a NATS KV bucket"}),"\n",(0,s.jsx)(n.li,{children:"A notification is published to a NATS stream"}),"\n",(0,s.jsx)(n.li,{children:"A worker receives the notification, reads the job from KV, and executes the\noperation"}),"\n",(0,s.jsx)(n.li,{children:"The worker writes the result to a response KV bucket"}),"\n",(0,s.jsx)(n.li,{children:"The client polls the API server, which reads the result from KV"}),"\n"]}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant CLI\n    participant API as API Server\n    participant NATS\n    participant Worker\n\n    CLI->>API: POST /job\n    API->>NATS: store job in KV\n    API->>NATS: publish notification\n    API--\x3e>CLI: 201 (job_id)\n    NATS->>Worker: deliver notification\n    Worker->>NATS: read job from KV\n    Worker->>Worker: execute operation\n    Worker->>NATS: write result to KV\n    CLI->>API: GET /job/{id}\n    API->>NATS: read result from KV\n    API--\x3e>CLI: 200 (result)"}),"\n",(0,s.jsx)(n.h2,{id:"job-routing",children:"Job Routing"}),"\n",(0,s.jsx)(n.p,{children:"Jobs can be targeted to specific workers using routing modes:"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Target"}),(0,s.jsx)(n.th,{children:"Behavior"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"_any"})}),(0,s.jsx)(n.td,{children:"Load-balanced across available workers (default)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"_all"})}),(0,s.jsx)(n.td,{children:"Broadcast to every worker"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"hostname"})}),(0,s.jsx)(n.td,{children:"Sent to a specific host"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"group:label"})}),(0,s.jsx)(n.td,{children:"Sent to all workers matching a label"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Workers register with their hostname and optional key-value labels. Labels\nsupport hierarchical matching with dot separators (e.g., ",(0,s.jsx)(n.code,{children:"group:web.dev"})," matches\nworkers with ",(0,s.jsx)(n.code,{children:"group: web.dev.us-east"}),")."]}),"\n",(0,s.jsx)(n.h2,{id:"job-lifecycle",children:"Job Lifecycle"}),"\n",(0,s.jsx)(n.p,{children:"Jobs progress through a defined set of states:"}),"\n",(0,s.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Pending\n    Pending --\x3e Running: worker picks up\n    Running --\x3e Completed: success\n    Running --\x3e Failed: error\n    Running --\x3e Retryable: transient error\n    Retryable --\x3e Pending: retry"}),"\n",(0,s.jsxs)(n.p,{children:["Jobs can be listed, inspected, deleted, and retried through the API and CLI. See\n",(0,s.jsx)(n.a,{href:"/osapi/sidebar/usage/cli/client/job/",children:"CLI Reference"})," for usage and examples, or the\n",(0,s.jsx)(n.a,{href:"/gen/api/job-management-api-job-operations",children:"API Reference"})," for the REST\nendpoints."]}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"nats:\n  kv:\n    bucket: 'job-queue' # KV bucket for job definitions\n    response_bucket: 'job-responses' # KV bucket for results\n    ttl: '1h' # Entry time-to-live\n    max_bytes: 104857600 # 100 MiB max bucket size\n\njob:\n  worker:\n    max_jobs: 10 # Max concurrent jobs\n    queue_group: 'job-workers' # Queue group for load balancing\n    hostname: '' # Defaults to OS hostname\n    labels: # Key-value labels for routing\n      group: 'web.dev.us-east'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/osapi/sidebar/usage/configuration",children:"Configuration"})," for the full reference including\nNATS stream, consumer, and DLQ settings."]}),"\n",(0,s.jsx)(n.h2,{id:"permissions",children:"Permissions"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Operation"}),(0,s.jsx)(n.th,{children:"Permission"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Create job"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"job:write"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"List/get jobs"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"job:read"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Delete job"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"job:write"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Retry job"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"job:write"})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/osapi/sidebar/usage/cli/client/job/",children:"CLI Reference"})," -- job commands"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/gen/api/job-management-api-job-operations",children:"API Reference"})," -- REST API\ndocumentation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/osapi/sidebar/architecture/job-architecture",children:"Job Architecture"})," -- KV-first design,\nsubject routing, worker pipeline"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/osapi/sidebar/architecture/",children:"Architecture"})," -- system design overview"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},28453(e,n,r){r.d(n,{R:()=>o,x:()=>a});var s=r(96540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);