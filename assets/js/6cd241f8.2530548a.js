"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[1295],{93112(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var t=s(74848),r=s(28453);const o={title:"Achieve 100% test coverage on non-generated packages",status:"done",created:new Date("2026-02-17T00:00:00.000Z"),updated:new Date("2026-02-18T00:00:00.000Z")},a=void 0,i={id:"sidebar/development/tasks/done/2026-02-17-test-coverage-100-percent",title:"Achieve 100% test coverage on non-generated packages",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-17-test-coverage-100-percent.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-17-test-coverage-100-percent",permalink:"/osapi/sidebar/development/tasks/done/2026-02-17-test-coverage-100-percent",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Achieve 100% test coverage on non-generated packages",status:"done",created:"2026-02-17T00:00:00.000Z",updated:"2026-02-18T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Rename cmd/util_*.go files to descriptive names",permalink:"/osapi/sidebar/development/tasks/done/2026-02-17-refactor-rename-util-validate"},next:{title:"Audit and clean up mocks repo-wide",permalink:"/osapi/sidebar/development/tasks/done/2026-02-17-test-mock-audit-cleanup"}},c={},l=[{value:"Objective",id:"objective",level:2},{value:"Packages and Gaps",id:"packages-and-gaps",level:2},{value:"1. <code>internal/api/system</code> \u2014 98.7% (target: 100%)",id:"1-internalapisystem--987-target-100",level:3},{value:"2. <code>internal/job/client</code> \u2014 99.6% (target: 100%)",id:"2-internaljobclient--996-target-100",level:3},{value:"Verification",id:"verification",level:2},{value:"Notes",id:"notes",level:2},{value:"Outcome",id:"outcome",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,t.jsx)(n.p,{children:"Two non-generated packages are below 100% statement coverage. Add tests for the\nuncovered branches to reach full coverage."}),"\n",(0,t.jsx)(n.h2,{id:"packages-and-gaps",children:"Packages and Gaps"}),"\n",(0,t.jsxs)(n.h3,{id:"1-internalapisystem--987-target-100",children:["1. ",(0,t.jsx)(n.code,{children:"internal/api/system"})," \u2014 98.7% (target: 100%)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Function:"})," ",(0,t.jsx)(n.code,{children:"GetSystemHostname"})," in ",(0,t.jsx)(n.code,{children:"system_hostname_get.go"})," \u2014 94.1%"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Uncovered branch (lines 62-65):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'displayHostname := result\nif displayHostname == "" {\n    displayHostname = workerHostname\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["When ",(0,t.jsx)(n.code,{children:"QuerySystemHostname"})," returns an empty string for the display hostname, the\nhandler falls back to ",(0,t.jsx)(n.code,{children:"workerHostname"}),". No test currently exercises this path."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Test to add"})," in ",(0,t.jsx)(n.code,{children:"system_hostname_get_public_test.go"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Mock ",(0,t.jsx)(n.code,{children:"QuerySystemHostname"})," to return ",(0,t.jsx)(n.code,{children:'("", "worker1", nil)'})," \u2014 empty result\nstring with a valid worker hostname."]}),"\n",(0,t.jsxs)(n.li,{children:["Assert response contains ",(0,t.jsx)(n.code,{children:'{"results":[{"hostname":"worker1"}]}'}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.h3,{id:"2-internaljobclient--996-target-100",children:["2. ",(0,t.jsx)(n.code,{children:"internal/job/client"})," \u2014 99.6% (target: 100%)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Function:"})," ",(0,t.jsx)(n.code,{children:"publishAndCollect"})," in ",(0,t.jsx)(n.code,{children:"client.go"})," \u2014 95.7%"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Uncovered branch A (lines 261-266):"})," Unmarshal error in broadcast response."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'if err := json.Unmarshal(entry.Value(), &response); err != nil {\n    c.logger.Warn("failed to unmarshal broadcast response", ...)\n    continue\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"When a KV watcher entry contains invalid JSON, the response is skipped with a\nwarning log. No test exercises this."}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Test to add:"})," Write invalid JSON to the response KV key for a broadcast job,\nthen write a valid response. Assert only the valid response is collected and the\ninvalid one is silently skipped."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Uncovered branch B (lines 270-272):"})," Empty hostname fallback."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'hostname := response.Hostname\nif hostname == "" {\n    hostname = "unknown"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["When a worker response has an empty ",(0,t.jsx)(n.code,{children:"Hostname"})," field, it is keyed as ",(0,t.jsx)(n.code,{children:'"unknown"'}),"\nin the results map. No test exercises this."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Test to add:"})," Write a valid response to KV with an empty ",(0,t.jsx)(n.code,{children:"Hostname"})," field.\nAssert the collected map has a key ",(0,t.jsx)(n.code,{children:'"unknown"'}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"go test -coverprofile=/tmp/cov.out ./internal/api/system/\ngo tool cover -func=/tmp/cov.out | grep -v 100.0%\n# Should show only total line\n\ngo test -coverprofile=/tmp/cov.out ./internal/job/client/\ngo tool cover -func=/tmp/cov.out | grep -v 100.0%\n# Should show only total line\n"})}),"\n",(0,t.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Generated packages (",(0,t.jsx)(n.code,{children:"gen/"}),", ",(0,t.jsx)(n.code,{children:"mocks/"}),") and ",(0,t.jsx)(n.code,{children:"cmd/"})," are excluded from this goal \u2014\nonly hand-written business logic packages are targeted."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"internal/api/network"})," package is already at 100%."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,t.jsxs)(n.p,{children:["All five hand-written packages reached 100% statement coverage as part of the\nlabel-based routing work (commit ",(0,t.jsx)(n.code,{children:"e813549"}),"):"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job"})," \u2014 100% (added ParseSubject invalid 4-part subject test)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/client"})," \u2014 100% (added ListWorkers skip tests, refactored\npublishAndCollect to share timeout return path)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/job/worker"})," \u2014 100% (added label consumer tests, hostname-with-labels\nprocessor test)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/api/system"})," \u2014 100% (added empty hostname fallback test)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"internal/api/network"})," \u2014 100% (already at 100%)"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453(e,n,s){s.d(n,{R:()=>a,x:()=>i});var t=s(96540);const r={},o=t.createContext(r);function a(e){const n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);