"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[9549],{26278(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>d,metadata:()=>o,toc:()=>a});var r=s(74848),t=s(28453);const d={title:"Add `changed` field to mutation responses",status:"done",created:new Date("2026-02-25T00:00:00.000Z"),updated:new Date("2026-02-25T00:00:00.000Z")},i=void 0,o={id:"sidebar/development/tasks/done/2026-02-25-add-changed-field-to-mutation-responses",title:"Add `changed` field to mutation responses",description:"Outcome",source:"@site/docs/sidebar/development/tasks/done/2026-02-25-add-changed-field-to-mutation-responses.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-25-add-changed-field-to-mutation-responses",permalink:"/osapi/sidebar/development/tasks/done/2026-02-25-add-changed-field-to-mutation-responses",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Add `changed` field to mutation responses",status:"done",created:"2026-02-25T00:00:00.000Z",updated:"2026-02-25T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Client SDK for programmatic automation",permalink:"/osapi/sidebar/development/tasks/done/2026-02-22-feat-client-sdk"},next:{title:"Backlog",permalink:"/osapi/category/backlog"}},l={},a=[{value:"Outcome",id:"outcome",level:2},{value:"Objective",id:"objective",level:2},{value:"Context",id:"context",level:2},{value:"Current mutating operations",id:"current-mutating-operations",level:3},{value:"Implementation Plan",id:"implementation-plan",level:2},{value:"Layer 1: Provider interface",id:"layer-1-provider-interface",level:3},{value:"Layer 2: Worker processor",id:"layer-2-worker-processor",level:3},{value:"Layer 3: Job response type",id:"layer-3-job-response-type",level:3},{value:"Layer 4: OpenAPI specs",id:"layer-4-openapi-specs",level:3},{value:"Layer 5: API handlers",id:"layer-5-api-handlers",level:3},{value:"Layer 6: SDK",id:"layer-6-sdk",level:3},{value:"Layer 7: CLI",id:"layer-7-cli",level:3},{value:"Layer 8: Tests",id:"layer-8-tests",level:3},{value:"Verification",id:"verification",level:2},{value:"Notes",id:"notes",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,r.jsxs)(n.p,{children:["Implemented across all layers: DNS provider (compare-before-write idempotency),\ncommand provider (always true), job response type, worker processor/handler, job\nclient, OpenAPI specs, API handlers, SDK, and CLI display. Full test coverage\nincluding ",(0,r.jsx)(n.code,{children:"extractChanged"}),", API response assertions, and CLI table rendering."]}),"\n",(0,r.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,r.jsxs)(n.p,{children:["Add a ",(0,r.jsx)(n.code,{children:"changed"})," boolean field to all mutation (TypeModify) operation responses\nso callers know whether the operation actually modified system state vs found it\nalready in the desired state. This is the foundational building block for\nidempotent automation tooling (like Ansible's ",(0,r.jsx)(n.code,{children:"changed: true/false"})," pattern)."]}),"\n",(0,r.jsx)(n.p,{children:"The field must propagate through the full stack: provider \u2192 worker \u2192 job\nresponse \u2192 API \u2192 SDK \u2192 CLI."}),"\n",(0,r.jsx)(n.h2,{id:"context",children:"Context"}),"\n",(0,r.jsx)(n.p,{children:'Currently, mutation responses (202 Accepted) report success/failure but not\nwhether state was actually modified. For example, a DNS update that writes the\nsame values already configured returns the same response as one that changes\nthem. An automation layer needs this distinction to report "3 of 5 operations\nchanged, 2 already converged."'}),"\n",(0,r.jsx)(n.h3,{id:"current-mutating-operations",children:"Current mutating operations"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Operation"}),(0,r.jsx)(n.th,{children:"Provider"}),(0,r.jsx)(n.th,{children:"Endpoint"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"DNS update"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"network/dns"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"PUT /network/dns"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Command exec"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"command"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"POST /command/exec"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Command shell"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"command"})}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"POST /command/shell"})})]})]})]}),"\n",(0,r.jsxs)(n.p,{children:['Note: command exec/shell always "change" (they execute arbitrary commands), so\n',(0,r.jsx)(n.code,{children:"changed"})," is always ",(0,r.jsx)(n.code,{children:"true"})," for them. DNS update is the first truly idempotent\nprovider where ",(0,r.jsx)(n.code,{children:"changed"})," has meaningful semantics."]}),"\n",(0,r.jsx)(n.h2,{id:"implementation-plan",children:"Implementation Plan"}),"\n",(0,r.jsx)(n.h3,{id:"layer-1-provider-interface",children:"Layer 1: Provider interface"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Files:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/provider/network/dns/types.go"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"internal/provider/network/dns/dns.go"})," (or platform impl)"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Add a ",(0,r.jsx)(n.code,{children:"Result"})," type to the DNS provider that includes ",(0,r.jsx)(n.code,{children:"Changed"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'type Result struct {\n    Changed bool `json:"changed"`\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Update ",(0,r.jsx)(n.code,{children:"UpdateResolvConfByInterface"})," to return ",(0,r.jsx)(n.code,{children:"(*Result, error)"}),". The\nimplementation compares current resolv.conf contents against desired before\nwriting \u2014 if identical, return ",(0,r.jsx)(n.code,{children:"Changed: false"})," without writing."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Command provider"})," (",(0,r.jsx)(n.code,{children:"internal/provider/command/types.go"}),"): Add ",(0,r.jsx)(n.code,{children:"Changed bool"}),"\nto the existing ",(0,r.jsx)(n.code,{children:"Result"})," struct. Always set to ",(0,r.jsx)(n.code,{children:"true"})," (commands always mutate by\ndefinition)."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-2-worker-processor",children:"Layer 2: Worker processor"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"internal/job/worker/processor.go"})]}),"\n",(0,r.jsxs)(n.p,{children:["Update ",(0,r.jsx)(n.code,{children:"processNetworkDNS"})," and command processors to read ",(0,r.jsx)(n.code,{children:"Changed"})," from the\nprovider result and include it in the result map written to KV."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-3-job-response-type",children:"Layer 3: Job response type"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"File:"})," ",(0,r.jsx)(n.code,{children:"internal/job/types.go"})]}),"\n",(0,r.jsxs)(n.p,{children:["Add ",(0,r.jsx)(n.code,{children:"Changed *bool"})," to ",(0,r.jsx)(n.code,{children:"Response"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'type Response struct {\n    JobID     string          `json:"job_id"`\n    Status    Status          `json:"status"`\n    Changed   *bool           `json:"changed,omitempty"`\n    Data      json.RawMessage `json:"data,omitempty"`\n    Error     string          `json:"error,omitempty"`\n    Hostname  string          `json:"hostname"`\n    Timestamp time.Time       `json:"timestamp"`\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"*bool"})," so read-only queries omit the field entirely (nil) rather than\nshowing ",(0,r.jsx)(n.code,{children:"false"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-4-openapi-specs",children:"Layer 4: OpenAPI specs"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Files:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/api/network/gen/api.yaml"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/api/command/gen/api.yaml"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Add ",(0,r.jsx)(n.code,{children:"changed"})," boolean to ",(0,r.jsx)(n.code,{children:"DNSUpdateResultItem"})," and ",(0,r.jsx)(n.code,{children:"CommandResultItem"})," schemas:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"changed:\n  type: boolean\n  description: Whether the operation modified system state.\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Run ",(0,r.jsx)(n.code,{children:"just generate"})," to regenerate ",(0,r.jsx)(n.code,{children:"*.gen.go"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-5-api-handlers",children:"Layer 5: API handlers"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Files:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/api/network/network_dns_put_by_interface.go"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/api/command/command_exec_post.go"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"internal/api/command/command_shell_post.go"})}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Populate the ",(0,r.jsx)(n.code,{children:"Changed"})," field from the job response when building the 202\nresponse."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-6-sdk",children:"Layer 6: SDK"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Repo:"})," ",(0,r.jsx)(n.code,{children:"osapi-sdk"})]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Update the merged OpenAPI spec and regenerate the client"}),"\n",(0,r.jsxs)(n.li,{children:["Expose ",(0,r.jsx)(n.code,{children:"Changed"})," in the service response types"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"layer-7-cli",children:"Layer 7: CLI"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Files:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"cmd/client_network_dns_update.go"})," (or equivalent)"]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"cmd/client_command_exec.go"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"cmd/client_command_shell.go"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Display changed status in output:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Hostname:  web-01\nStatus:    ok\nChanged:   true\n"})}),"\n",(0,r.jsxs)(n.p,{children:["For ",(0,r.jsx)(n.code,{children:"--json"})," output, the field comes through naturally from the API response."]}),"\n",(0,r.jsx)(n.h3,{id:"layer-8-tests",children:"Layer 8: Tests"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Provider unit tests: verify ",(0,r.jsx)(n.code,{children:"Changed: false"})," when state matches,\n",(0,r.jsx)(n.code,{children:"Changed: true"})," when state differs"]}),"\n",(0,r.jsxs)(n.li,{children:["Worker processor tests: verify ",(0,r.jsx)(n.code,{children:"changed"})," propagates into result"]}),"\n",(0,r.jsxs)(n.li,{children:["API integration tests: verify ",(0,r.jsx)(n.code,{children:"changed"})," field present in 202 responses"]}),"\n",(0,r.jsxs)(n.li,{children:["CLI: verify ",(0,r.jsx)(n.code,{children:"Changed"})," appears in output"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"just generate\ngo build ./...\njust go::unit\njust go::vet\n"})}),"\n",(0,r.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Future providers that implement idempotent mutations (e.g., hostname set,\nnetwork interface config) should follow this same pattern from day one."}),"\n",(0,r.jsxs)(n.li,{children:["The ",(0,r.jsx)(n.code,{children:"changed"})," field is the foundation for the planned automation layer\n(",(0,r.jsx)(n.code,{children:"osapi-apply"}),") which needs to aggregate change status across multiple\noperations."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453(e,n,s){s.d(n,{R:()=>i,x:()=>o});var r=s(96540);const t={},d=r.createContext(t);function i(e){const n=r.useContext(d);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(d.Provider,{value:n},e.children)}}}]);