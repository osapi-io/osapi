"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[8336],{2558(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var s=t(74848),r=t(28453);const o={title:"Add custom OTel metrics for jobs, workers, and NATS",status:"backlog",created:new Date("2026-02-20T00:00:00.000Z"),updated:new Date("2026-02-20T00:00:00.000Z")},i=void 0,c={id:"sidebar/development/tasks/backlog/2026-02-20-feat-metrics-endpoint",title:"Add custom OTel metrics for jobs, workers, and NATS",description:"Objective",source:"@site/docs/sidebar/development/tasks/backlog/2026-02-20-feat-metrics-endpoint.md",sourceDirName:"sidebar/development/tasks/backlog",slug:"/sidebar/development/tasks/backlog/2026-02-20-feat-metrics-endpoint",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-20-feat-metrics-endpoint",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Add custom OTel metrics for jobs, workers, and NATS",status:"backlog",created:"2026-02-20T00:00:00.000Z",updated:"2026-02-20T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Add MCP server for AI agent integration",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-18-feat-mcp-server"},next:{title:"Evaluate query param validation strategy",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-21-discuss-query-param-validation"}},d={},l=[{value:"Objective",id:"objective",level:2},{value:"Metrics to Add",id:"metrics-to-add",level:2},{value:"Job metrics (instrument in <code>internal/job/client/</code> and worker)",id:"job-metrics-instrument-in-internaljobclient-and-worker",level:3},{value:"Worker metrics (instrument in <code>internal/job/worker/</code>)",id:"worker-metrics-instrument-in-internaljobworker",level:3},{value:"NATS metrics",id:"nats-metrics",level:3},{value:"Approach",id:"approach",level:2},{value:"Key packages",id:"key-packages",level:3},{value:"Components to update",id:"components-to-update",level:3},{value:"Notes",id:"notes",level:2},{value:"Outcome",id:"outcome",level:2}];function a(e){const n={code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"/metrics"})," endpoint and Prometheus exporter are in place (see\n",(0,s.jsx)(n.code,{children:".tasks/done/2026-02-20-feat-metrics-endpoint.md"}),"), and ",(0,s.jsx)(n.code,{children:"otelecho"})," already\nprovides HTTP request metrics automatically. This task adds custom\napplication-level metrics using the OTel metrics API so operators get visibility\ninto job throughput, worker health, and NATS connectivity."]}),"\n",(0,s.jsx)(n.h2,{id:"metrics-to-add",children:"Metrics to Add"}),"\n",(0,s.jsxs)(n.h3,{id:"job-metrics-instrument-in-internaljobclient-and-worker",children:["Job metrics (instrument in ",(0,s.jsx)(n.code,{children:"internal/job/client/"})," and worker)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_jobs_created_total"})," \u2014 counter of jobs created"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_jobs_completed_total"})," \u2014 counter by status (completed/failed)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_job_duration_seconds"})," \u2014 histogram of job processing time"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_jobs_active"})," \u2014 gauge of currently processing jobs"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"worker-metrics-instrument-in-internaljobworker",children:["Worker metrics (instrument in ",(0,s.jsx)(n.code,{children:"internal/job/worker/"}),")"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_workers_connected"})," \u2014 gauge of connected workers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_worker_jobs_processed_total"})," \u2014 counter per worker"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"nats-metrics",children:"NATS metrics"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_nats_connected"})," \u2014 gauge (1/0) for connection status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"osapi_nats_reconnects_total"})," \u2014 counter of reconnect events"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"approach",children:"Approach"}),"\n",(0,s.jsxs)(n.p,{children:["Use the OTel metrics API (",(0,s.jsx)(n.code,{children:"go.opentelemetry.io/otel/metric"}),") to define counters,\nhistograms, and gauges. The global ",(0,s.jsx)(n.code,{children:"MeterProvider"})," is already set by\n",(0,s.jsx)(n.code,{children:"InitMeter()"})," in ",(0,s.jsx)(n.code,{children:"internal/telemetry/metrics.go"}),", so instruments created via\n",(0,s.jsx)(n.code,{children:'otel.Meter("osapi")'})," will automatically be scraped by the existing Prometheus\nexporter at ",(0,s.jsx)(n.code,{children:"/metrics"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"key-packages",children:"Key packages"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"go.opentelemetry.io/otel/metric"})," \u2014 create instruments"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"go.opentelemetry.io/otel"})," \u2014 get global meter"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"components-to-update",children:"Components to update"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/job/worker/processor.go"})," \u2014 record job duration, active jobs,\ncompletion status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/job/worker/consumer.go"})," \u2014 record worker connection status"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/job/client/"})," \u2014 record job creation counter"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cmd/job_worker_start.go"})," \u2014 init worker-side meter provider"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Worker runs as a separate process \u2014 it needs its own ",(0,s.jsx)(n.code,{children:"InitMeter()"})," call and\n",(0,s.jsx)(n.code,{children:"/metrics"})," endpoint (or push-based exporter)"]}),"\n",(0,s.jsxs)(n.li,{children:["All metric names should use ",(0,s.jsx)(n.code,{children:"osapi_"})," prefix to avoid collisions"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"metric.WithDescription()"})," and ",(0,s.jsx)(n.code,{children:"metric.WithUnit()"})," for each instrument so\nPrometheus exposition includes HELP and UNIT lines"]}),"\n",(0,s.jsx)(n.li,{children:"Consider whether worker metrics should be exposed via a separate HTTP port or\npushed to an OTel collector"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"outcome",children:"Outcome"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"To be filled in when done."})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},28453(e,n,t){t.d(n,{R:()=>i,x:()=>c});var s=t(96540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);