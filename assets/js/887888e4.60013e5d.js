"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[2697],{71017(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>a});var s=t(74848),i=t(28453);const r={title:"File and directory management",status:"backlog",created:new Date("2026-02-15T00:00:00.000Z"),updated:new Date("2026-02-19T00:00:00.000Z")},l=void 0,o={id:"sidebar/development/tasks/backlog/2026-02-15-feat-file-management",title:"File and directory management",description:"Objective",source:"@site/docs/sidebar/development/tasks/backlog/2026-02-15-feat-file-management.md",sourceDirName:"sidebar/development/tasks/backlog",slug:"/sidebar/development/tasks/backlog/2026-02-15-feat-file-management",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-15-feat-file-management",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"File and directory management",status:"backlog",created:"2026-02-15T00:00:00.000Z",updated:"2026-02-19T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"System facts/inventory gathering",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-15-feat-facts-gathering"},next:{title:"Firewall management (ufw/nftables)",permalink:"/osapi/sidebar/development/tasks/backlog/2026-02-15-feat-firewall-management"}},d={},a=[{value:"Objective",id:"objective",level:2},{value:"Part 1: Blob Store (<code>/blobs</code>)",id:"part-1-blob-store-blobs",level:2},{value:"API Endpoints",id:"api-endpoints",level:3},{value:"Two Modes",id:"two-modes",level:3},{value:"Storage Backend Interface",id:"storage-backend-interface",level:3},{value:"Backends",id:"backends",level:3},{value:"How Jobs Reference Blobs",id:"how-jobs-reference-blobs",level:3},{value:"Package",id:"package",level:3},{value:"Part 2: File Operations (<code>/file</code>)",id:"part-2-file-operations-file",level:2},{value:"API Endpoints",id:"api-endpoints-1",level:3},{value:"Operations",id:"operations",level:3},{value:"Provider",id:"provider",level:3},{value:"Prerequisites: nats-client Object Store Support",id:"prerequisites-nats-client-object-store-support",level:2},{value:"Files to add in nats-client",id:"files-to-add-in-nats-client",level:3},{value:"Implementation Order",id:"implementation-order",level:2},{value:"Notes",id:"notes",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"objective",children:"Objective"}),"\n",(0,s.jsxs)(n.p,{children:["Add file and directory management in two parts: a content-addressed ",(0,s.jsx)(n.strong,{children:"blob\nstore"})," for getting files onto the system, and ",(0,s.jsx)(n.strong,{children:"file operations"})," for managing\nfiles on disk. The blob store is a shared primitive \u2014 any future feature that\nneeds to push files to workers (configs, certs, packages) uses the same\nupload-once, reference-by-SHA mechanism."]}),"\n",(0,s.jsxs)(n.h2,{id:"part-1-blob-store-blobs",children:["Part 1: Blob Store (",(0,s.jsx)(n.code,{children:"/blobs"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Content-addressed file storage with pluggable backends. Files are immutable \u2014\nsame SHA = same content, no re-upload needed."}),"\n",(0,s.jsx)(n.h3,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"POST   /blobs                 - Upload file to managed store (default: NATS)\nPOST   /blobs/register        - Register external reference (s3://, file://, https://)\nHEAD   /blobs/{sha256}        - Check if blob exists (no download)\nGET    /blobs/{sha256}        - Download blob content (managed only)\nDELETE /blobs/{sha256}        - Remove blob (admin only)\nGET    /blobs                 - List blobs (with metadata, pagination)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"two-modes",children:"Two Modes"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Managed (default):"})," ",(0,s.jsx)(n.code,{children:"POST /blobs"})," uploads bytes into the configured backend\n(NATS Object Store by default). The API server receives the file and stores it.\nGood for config files, scripts, small binaries."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"External reference:"})," ",(0,s.jsx)(n.code,{children:"POST /blobs/register"})," records a pointer to a file that\nalready lives somewhere workers can reach \u2014 S3 bucket, NFS mount, HTTPS URL. No\nbytes are transferred through OSAPI. Good for ISOs, large packages, anything\nalready hosted. Workers resolve the source at execution time."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type BlobRef struct {\n    SHA256 string // content hash (required for both modes)\n    Source string // "managed" | "s3://..." | "file:///..." | "https://..."\n    Size   int64\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"storage-backend-interface",children:"Storage Backend Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'type BlobStore interface {\n    Put(ctx context.Context, reader io.Reader, metadata BlobMetadata) (sha256 string, err error)\n    Get(ctx context.Context, sha256 string) (io.ReadCloser, BlobMetadata, error)\n    Exists(ctx context.Context, sha256 string) (bool, error)\n    Delete(ctx context.Context, sha256 string) error\n    List(ctx context.Context, opts ListOptions) ([]BlobMetadata, error)\n}\n\ntype BlobMetadata struct {\n    SHA256    string\n    Size      int64\n    Filename  string    // original filename (informational)\n    MIMEType  string    // detected or provided\n    CreatedAt time.Time\n    Backend   string    // "nats", "s3", "fs", etc.\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"backends",children:"Backends"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Backend"}),(0,s.jsx)(n.th,{children:"Config key"}),(0,s.jsx)(n.th,{children:"Best for"}),(0,s.jsx)(n.th,{children:"Notes"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"NATS Object Store"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"blobs.backend: nats"})}),(0,s.jsx)(n.td,{children:"Small-medium files (<100MB), single-node or small clusters"}),(0,s.jsx)(n.td,{children:"Built-in, no extra infra. Uses JetStream chunking."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"S3-compatible"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"blobs.backend: s3"})}),(0,s.jsx)(n.td,{children:"Large files, existing cloud infra"}),(0,s.jsx)(n.td,{children:"AWS S3, MinIO, R2, etc."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Filesystem"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"blobs.backend: fs"})}),(0,s.jsx)(n.td,{children:"NAS/NFS mounts, air-gapped environments"}),(0,s.jsx)(n.td,{children:"Simple directory on a shared mount."})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Backend is selected via config. Workers use the same interface to pull blobs\nregardless of backend:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'blobs:\n  backend: nats # or "s3" or "fs"\n\n  nats:\n    bucket: osapi-blobs\n    chunk_size: 262144 # 256KB chunks\n\n  s3:\n    endpoint: s3.amazonaws.com\n    bucket: osapi-blobs\n    region: us-east-1\n    # credentials via env: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY\n\n  fs:\n    path: /var/lib/osapi/blobs\n'})}),"\n",(0,s.jsx)(n.h3,{id:"how-jobs-reference-blobs",children:"How Jobs Reference Blobs"}),"\n",(0,s.jsx)(n.p,{children:"Operations that need a file include the SHA in the job payload instead of inline\ncontent. Workers pull the blob from the configured store when executing:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "type": "file.write.execute",\n  "data": {\n    "path": "/etc/nginx/nginx.conf",\n    "source_sha256": "a1b2c3...",\n    "mode": "0644",\n    "owner": "root"\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Upload once, deploy to many workers (broadcast ",(0,s.jsx)(n.code,{children:"_all"})," or label targeting). CLI\nworkflow:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Upload a file to managed store (default: NATS Object Store)\nosapi client blob upload nginx.conf\n# \u2192 sha256: a1b2c3..., source: managed, backend: nats\n\n# Register an external file (no upload, just a pointer)\nosapi client blob register \\\n  --sha256 def456... \\\n  --source s3://my-bucket/images/ubuntu-24.04.iso \\\n  --size 4294967296\n\n# Check if a blob exists (works for both managed and external)\nosapi client blob check a1b2c3...\n# \u2192 exists: true, size: 4096, source: managed\n\n# Use it in a job \u2014 worker resolves source automatically\nosapi client file write /etc/nginx/nginx.conf \\\n  --source-sha a1b2c3... --mode 0644\n"})}),"\n",(0,s.jsx)(n.h3,{id:"package",children:"Package"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/blob/"})," \u2014 ",(0,s.jsx)(n.code,{children:"BlobStore"})," interface + backend implementations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/api/blob/"})," \u2014 API handlers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal/client/blob_*.go"})," \u2014 client wrappers"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"cmd/client_blob*.go"})," \u2014 CLI commands"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"part-2-file-operations-file",children:["Part 2: File Operations (",(0,s.jsx)(n.code,{children:"/file"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"File and directory management on the target system. Write operations reference\nblobs by SHA for file content."}),"\n",(0,s.jsx)(n.h3,{id:"api-endpoints-1",children:"API Endpoints"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET    /file/stat             - Get file/directory metadata\nPOST   /file/read             - Read file contents (with line range)\nPUT    /file/write            - Write file from blob SHA or inline content\nPATCH  /file/line             - Insert/replace/remove line in file\nPUT    /file/permissions      - Set owner, group, mode\nPOST   /file/directory        - Create directory (mkdir -p)\nDELETE /file/{path}           - Delete file or directory\nPOST   /file/copy             - Copy file within the system\n"})}),"\n",(0,s.jsx)(n.h3,{id:"operations",children:"Operations"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.stat.get"})," (query) \u2014 Ansible ",(0,s.jsx)(n.code,{children:"stat"})," equivalent"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.read.get"})," (query)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.write.execute"})," (modify) \u2014 write from blob SHA or small inline content"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.line.update"})," (modify) \u2014 Ansible ",(0,s.jsx)(n.code,{children:"lineinfile"})," equivalent"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.permissions.update"})," (modify) \u2014 Ansible ",(0,s.jsx)(n.code,{children:"file"})," with mode/owner"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.directory.create"})," (modify)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.delete.execute"})," (modify)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"file.copy.execute"})," (modify)"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"provider",children:"Provider"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"internal/provider/system/file/"})}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"stat"}),": path, size, mode, owner, group, modified, is_dir, is_link, checksum\n(sha256)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"read"}),": line offset/limit, binary detection"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"write"}),": accept blob SHA or inline content + mode + owner, create parent dirs,\noptional backup"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"line"}),": regexp match, insertafter, insertbefore, state (present/absent) \u2014\nmirrors Ansible lineinfile"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"permissions"}),": ",(0,s.jsx)(n.code,{children:"chown"}),", ",(0,s.jsx)(n.code,{children:"chmod"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites-nats-client-object-store-support",children:"Prerequisites: nats-client Object Store Support"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"nats-client"})," sibling repo wraps JetStream KV, Streams, and Consumers but\ndoes ",(0,s.jsx)(n.strong,{children:"not"})," yet wrap Object Store. The NATS backend for the blob store depends\non it."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"nats-server: No changes needed."})," Object Store is a JetStream primitive \u2014\nautomatically available when JetStream is enabled."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"nats-client: Must add Object Store wrapper."})," The upstream NATS Go library\n(v1.48.0) already has the full Object Store API, and mocks are already generated\nfrom the JetStream interfaces. Just needs a wrapper layer following the ",(0,s.jsx)(n.code,{children:"kv.go"}),"\npattern."]}),"\n",(0,s.jsx)(n.h3,{id:"files-to-add-in-nats-client",children:"Files to add in nats-client"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"pkg/client/objectstore.go"})," \u2014 wrapper methods:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"CreateObjectStore(ctx, config)"})," \u2014 create an Object Store bucket"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GetObjectStore(ctx, name)"})," \u2014 get existing bucket"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"DeleteObjectStore(ctx, name)"})," \u2014 delete bucket"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"PutObject(ctx, store, name, reader)"})," \u2014 store object (chunked)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"GetObject(ctx, store, name)"})," \u2014 retrieve object"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"DeleteObject(ctx, store, name)"})," \u2014 delete object"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ListObjects(ctx, store)"})," \u2014 list objects in a bucket"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ObjectInfo(ctx, store, name)"})," \u2014 get object metadata"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"pkg/client/objectstore_public_test.go"})," \u2014 full test coverage following the\n",(0,s.jsx)(n.code,{children:"kv_public_test.go"})," table-driven pattern. Must maintain 100% coverage."]}),"\n",(0,s.jsx)(n.h2,{id:"implementation-order",children:"Implementation Order"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"nats-client Object Store wrapper"})," \u2014 add to sibling repo first"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Blob store interface + NATS backend"})," \u2014 ",(0,s.jsx)(n.code,{children:"internal/blob/"})," using the new\nnats-client Object Store methods"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Blob API + CLI"})," \u2014 upload/check/download/list/register"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File operations provider"})," \u2014 stat, read, write (with blob integration),\npermissions"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"File API + CLI"})," \u2014 endpoints and commands"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"S3 backend"})," \u2014 add when needed"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Filesystem backend"})," \u2014 add when needed"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Blob uploads go direct to the API server (not through the job system) \u2014\nthey're infrastructure, not operations"}),"\n",(0,s.jsx)(n.li,{children:"File operations go through the job system as usual (worker executes on target\nhost)"}),"\n",(0,s.jsx)(n.li,{children:"Workers need access to the blob store to pull files \u2014 same config, same\ninterface"}),"\n",(0,s.jsx)(n.li,{children:"Path validation to prevent directory traversal attacks"}),"\n",(0,s.jsx)(n.li,{children:"Size limits on inline content (small config snippets OK, large files must use\nblob SHA)"}),"\n",(0,s.jsxs)(n.li,{children:["Scopes: ",(0,s.jsx)(n.code,{children:"blob:read"}),", ",(0,s.jsx)(n.code,{children:"blob:write"})," for the store; ",(0,s.jsx)(n.code,{children:"file:read"}),", ",(0,s.jsx)(n.code,{children:"file:write"})," for\noperations"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lineinfile"})," regex-based editing is one of Ansible's most-used features \u2014\nworth getting right"]}),"\n",(0,s.jsx)(n.li,{children:"Consider a diff/preview endpoint before applying changes"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453(e,n,t){t.d(n,{R:()=>l,x:()=>o});var s=t(96540);const i={},r=s.createContext(i);function l(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);