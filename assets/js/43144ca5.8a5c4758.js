"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[4198],{28086(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});var t=r(74848),s=r(28453);const i={sidebar_position:7},o="Distributed Tracing",a={id:"sidebar/features/distributed-tracing",title:"Distributed Tracing",description:"OSAPI uses OpenTelemetry to propagate a single",source:"@site/docs/sidebar/features/distributed-tracing.md",sourceDirName:"sidebar/features",slug:"/sidebar/features/distributed-tracing",permalink:"/osapi/sidebar/features/distributed-tracing",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"testSidebar",previous:{title:"Authentication & RBAC",permalink:"/osapi/sidebar/features/authentication"},next:{title:"Metrics",permalink:"/osapi/sidebar/features/metrics"}},d={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Debugging with Traces",id:"debugging-with-traces",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Log correlation (recommended default)",id:"log-correlation-recommended-default",level:3},{value:"OTLP export (production)",id:"otlp-export-production",level:3},{value:"Related",id:"related",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"distributed-tracing",children:"Distributed Tracing"})}),"\n",(0,t.jsxs)(n.p,{children:["OSAPI uses ",(0,t.jsx)(n.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," to propagate a single\ntrace ID through every component in a request flow. When tracing is enabled, you\ncan follow a request from CLI to API server to worker by filtering logs on\n",(0,t.jsx)(n.code,{children:"trace_id"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,t.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant CLI\n    participant API as API Server\n    participant Worker\n\n    CLI->>CLI: create root span\n    CLI->>API: HTTP request + traceparent header\n    API->>API: continue trace (otelecho)\n    API->>Worker: NATS message + traceparent header\n    Worker->>Worker: extract context, create job.process span"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"CLI"})," creates a root span and injects ",(0,t.jsx)(n.code,{children:"traceparent"})," into the HTTP request"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"API Server"})," continues the trace via ",(0,t.jsx)(n.code,{children:"otelecho"})," middleware, then the\nnats-client automatically injects trace context into NATS message headers\nwhen publishing job notifications"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Worker"})," extracts trace context from the NATS message headers and creates a\n",(0,t.jsx)(n.code,{children:"job.process"})," span, linking its work to the original request"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["All structured log lines include ",(0,t.jsx)(n.code,{children:"trace_id"})," and ",(0,t.jsx)(n.code,{children:"span_id"})," when a span is active,\nso ",(0,t.jsx)(n.code,{children:"grep trace_id=<hex>"})," shows the complete end-to-end flow."]}),"\n",(0,t.jsx)(n.h2,{id:"debugging-with-traces",children:"Debugging with Traces"}),"\n",(0,t.jsx)(n.p,{children:"To trace a request end-to-end:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Run all three processes with ",(0,t.jsx)(n.code,{children:"--debug"})," (or ",(0,t.jsx)(n.code,{children:"telemetry.tracing.enabled: true"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Execute a command: ",(0,t.jsx)(n.code,{children:"osapi client system hostname"})]}),"\n",(0,t.jsxs)(n.li,{children:["Find the ",(0,t.jsx)(n.code,{children:"trace_id"})," in any component's log output"]}),"\n",(0,t.jsxs)(n.li,{children:["Filter all logs: ",(0,t.jsx)(n.code,{children:"grep trace_id=<hex>"})," across API server and worker output"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Example log output showing the same trace ID across components:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"# API Server\nINF publishing job request  job_id=abc123 trace_id=e0fd287f... span_id=1a2b3c...\nINF received job response   job_id=abc123 trace_id=e0fd287f... span_id=1a2b3c...\n\n# Worker\nINF processing job          job_id=abc123 trace_id=e0fd287f... span_id=4d5e6f...\nINF job processing completed job_id=abc123 trace_id=e0fd287f... span_id=4d5e6f...\n"})}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Tracing is off by default. The ",(0,t.jsx)(n.code,{children:"exporter"})," field controls where spans are sent:"]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:(0,t.jsx)(n.code,{children:"exporter"})}),(0,t.jsx)(n.th,{children:"Behavior"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.em,{children:"(unset)"})}),(0,t.jsxs)(n.td,{children:["Log correlation only -- ",(0,t.jsx)(n.code,{children:"trace_id"})," appears in structured logs but no spans are exported"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"stdout"})}),(0,t.jsx)(n.td,{children:"Raw OpenTelemetry span JSON dumped directly to stdout (bypasses the structured logger -- useful for one-off debugging but noisy)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"otlp"})}),(0,t.jsx)(n.td,{children:"Spans sent via gRPC to a tracing backend (Jaeger, Tempo, etc.)"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"--debug"})," flag auto-enables tracing with ",(0,t.jsx)(n.strong,{children:"no exporter"})," (log correlation\nonly). It does not enable the ",(0,t.jsx)(n.code,{children:"stdout"})," exporter."]}),"\n",(0,t.jsx)(n.h3,{id:"log-correlation-recommended-default",children:"Log correlation (recommended default)"}),"\n",(0,t.jsxs)(n.p,{children:["Enable tracing so ",(0,t.jsx)(n.code,{children:"trace_id"})," and ",(0,t.jsx)(n.code,{children:"span_id"})," appear in structured log lines. No\nspans are exported -- you correlate requests by grepping logs."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"telemetry:\n  tracing:\n    enabled: true\n"})}),"\n",(0,t.jsx)(n.h3,{id:"otlp-export-production",children:"OTLP export (production)"}),"\n",(0,t.jsxs)(n.p,{children:["Send spans to a self-hosted tracing backend like\n",(0,t.jsx)(n.a,{href:"https://www.jaegertracing.io/",children:"Jaeger"})," or\n",(0,t.jsx)(n.a,{href:"https://grafana.com/oss/tempo/",children:"Grafana Tempo"}),". The ",(0,t.jsx)(n.code,{children:"otlp_endpoint"})," is the gRPC\naddress of that backend."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"telemetry:\n  tracing:\n    enabled: true\n    exporter: otlp\n    otlp_endpoint: localhost:4317\n"})}),"\n",(0,t.jsxs)(n.admonition,{title:"The OTLP exporter currently uses an insecure (non-TLS) gRPC connection",type:"note",children:[(0,t.jsx)(n.p,{children:"with no authentication. This works for local or internal backends but not for\ncloud services (Grafana Cloud, Honeycomb, Datadog) that require TLS and API\nkeys. Authenticated OTLP is planned. :::"}),(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"/osapi/sidebar/usage/configuration#telemetrytracing",children:"Configuration"})," for the full\nreference."]}),(0,t.jsx)(n.h2,{id:"related",children:"Related"}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/osapi/sidebar/usage/configuration",children:"Configuration"})," -- full configuration reference"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/osapi/sidebar/architecture/",children:"Architecture"})," -- system design overview"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/osapi/sidebar/features/job-system",children:"Job System"})," -- how async job processing works"]}),"\n"]})]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,n,r){r.d(n,{R:()=>o,x:()=>a});var t=r(96540);const s={},i=t.createContext(s);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);