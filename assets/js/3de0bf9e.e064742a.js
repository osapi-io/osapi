"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7779],{82171(e,t,n){n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>d,toc:()=>l});var i=n(74848),s=n(28453);const r={title:"HTTP metrics with Prometheus endpoint",status:"done",created:new Date("2026-02-20T00:00:00.000Z"),updated:new Date("2026-02-20T00:00:00.000Z")},o=void 0,d={id:"sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint",title:"HTTP metrics with Prometheus endpoint",description:"Objective",source:"@site/docs/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint.md",sourceDirName:"sidebar/development/tasks/done",slug:"/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-metrics-endpoint",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"HTTP metrics with Prometheus endpoint",status:"done",created:"2026-02-20T00:00:00.000Z",updated:"2026-02-20T00:00:00.000Z"},sidebar:"testSidebar",previous:{title:"Distributed tracing with OpenTelemetry",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-distributed-tracing"},next:{title:"Add NATS authentication and namespace support to config",permalink:"/osapi/sidebar/development/tasks/done/2026-02-20-feat-nats-auth-namespaces"}},c={},l=[{value:"Objective",id:"objective",level:2},{value:"Scope",id:"scope",level:2},{value:"Approach",id:"approach",level:2},{value:"Notes",id:"notes",level:2},{value:"Outcome",id:"outcome",level:2},{value:"Prometheus metrics",id:"prometheus-metrics",level:3},{value:"Missing integration tests",id:"missing-integration-tests",level:3}];function a(e){const t={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h2,{id:"objective",children:"Objective"}),"\n",(0,i.jsxs)(t.p,{children:["Expose an opt-in ",(0,i.jsx)(t.code,{children:"/metrics"})," endpoint on the API server that serves\nPrometheus-compatible HTTP metrics using OpenTelemetry's metrics SDK. The\n",(0,i.jsx)(t.code,{children:"otelecho"})," middleware (already wired) automatically records\n",(0,i.jsx)(t.code,{children:"http.server.request.duration"})," and ",(0,i.jsx)(t.code,{children:"http.server.active_requests"})," when a global\n",(0,i.jsx)(t.code,{children:"MeterProvider"})," is set."]}),"\n",(0,i.jsx)(t.h2,{id:"scope",children:"Scope"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"HTTP metrics only"})," (automatic via otelecho middleware):"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"http_server_request_duration_seconds"})," \u2014 request latency histogram"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"http_server_active_requests"})," \u2014 in-flight request gauge"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Custom job/worker metrics are a separate follow-up task \u2014 see\n",(0,i.jsx)(t.code,{children:".tasks/backlog/2026-02-20-feat-custom-job-metrics.md"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"approach",children:"Approach"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Add ",(0,i.jsx)(t.code,{children:"go.opentelemetry.io/otel/sdk/metric"})," and\n",(0,i.jsx)(t.code,{children:"go.opentelemetry.io/otel/exporters/prometheus"})," as direct deps"]}),"\n",(0,i.jsxs)(t.li,{children:["Add ",(0,i.jsx)(t.code,{children:"MetricsConfig"})," to ",(0,i.jsx)(t.code,{children:"internal/config/types.go"})]}),"\n",(0,i.jsxs)(t.li,{children:["Create ",(0,i.jsx)(t.code,{children:"internal/telemetry/metrics.go"})," with ",(0,i.jsx)(t.code,{children:"InitMeter()"})," that creates a\nPrometheus exporter and sets it as global MeterProvider"]}),"\n",(0,i.jsxs)(t.li,{children:["Wire into ",(0,i.jsx)(t.code,{children:"cmd/api_server_start.go"})," and register ",(0,i.jsx)(t.code,{children:"/metrics"})," route on Echo via\n",(0,i.jsx)(t.code,{children:"WithMetricsHandler"})," option"]}),"\n",(0,i.jsxs)(t.li,{children:["Auto-enable in debug mode, default path ",(0,i.jsx)(t.code,{children:"/metrics"})]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"notes",children:"Notes"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"/metrics"})," is unauthenticated (Prometheus convention)"]}),"\n",(0,i.jsx)(t.li,{children:"Registered directly on Echo, not through OpenAPI handler pipeline"}),"\n",(0,i.jsx)(t.li,{children:"Debug mode auto-enables metrics (same pattern as tracing)"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"outcome",children:"Outcome"}),"\n",(0,i.jsxs)(t.p,{children:["Implemented Prometheus ",(0,i.jsx)(t.code,{children:"/metrics"})," endpoint and added missing integration tests."]}),"\n",(0,i.jsx)(t.h3,{id:"prometheus-metrics",children:"Prometheus metrics"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Added ",(0,i.jsx)(t.code,{children:"MetricsConfig"})," to ",(0,i.jsx)(t.code,{children:"internal/config/types.go"})]}),"\n",(0,i.jsxs)(t.li,{children:["Created ",(0,i.jsx)(t.code,{children:"internal/telemetry/metrics.go"})," with ",(0,i.jsx)(t.code,{children:"InitMeter()"})," \u2014 creates\nPrometheus exporter, sets global MeterProvider, returns promhttp handler"]}),"\n",(0,i.jsxs)(t.li,{children:["Created ",(0,i.jsx)(t.code,{children:"internal/telemetry/metrics_test.go"})," \u2014 covers default path, custom\npath, and exporter error path"]}),"\n",(0,i.jsxs)(t.li,{children:["Created ",(0,i.jsx)(t.code,{children:"internal/api/handler_metrics.go"})," \u2014 ",(0,i.jsx)(t.code,{children:"GetMetricsHandler()"})," registers\nunauthenticated ",(0,i.jsx)(t.code,{children:"/metrics"})," route directly on Echo"]}),"\n",(0,i.jsxs)(t.li,{children:["Wired into ",(0,i.jsx)(t.code,{children:"cmd/api_server_start.go"})," with shutdown in cleanup closure"]}),"\n",(0,i.jsxs)(t.li,{children:["Added ",(0,i.jsx)(t.code,{children:"TestGetMetricsHandler"})," to ",(0,i.jsx)(t.code,{children:"internal/api/handler_public_test.go"})]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"missing-integration-tests",children:"Missing integration tests"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"internal/api/health/health_get_integration_test.go"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"internal/api/health/health_ready_get_integration_test.go"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"internal/api/health/health_status_get_integration_test.go"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"internal/api/job/job_status_integration_test.go"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"internal/api/job/job_workers_get_integration_test.go"})}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},28453(e,t,n){n.d(t,{R:()=>o,x:()=>d});var i=n(96540);const s={},r=i.createContext(s);function o(e){const t=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);