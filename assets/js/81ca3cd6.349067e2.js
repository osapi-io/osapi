"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[5398],{86717(e,r,n){n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var t=n(74848),s=n(28453);const i={sidebar_position:1,sidebar_label:"Overview"},a="Architecture",o={id:"sidebar/architecture/architecture",title:"Architecture",description:"OSAPI turns Linux servers into managed appliances. You install a single binary,",source:"@site/docs/sidebar/architecture/architecture.md",sourceDirName:"sidebar/architecture",slug:"/sidebar/architecture/",permalink:"/osapi/sidebar/architecture/",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,sidebar_label:"Overview"},sidebar:"testSidebar",previous:{title:"Home",permalink:"/osapi/"},next:{title:"System Architecture",permalink:"/osapi/sidebar/architecture/system-architecture"}},l={},d=[{value:"The Three Processes",id:"the-three-processes",level:2},{value:"NATS Server",id:"nats-server",level:3},{value:"API Server",id:"api-server",level:3},{value:"Worker",id:"worker",level:3},{value:"Deployment Models",id:"deployment-models",level:2},{value:"Single Host",id:"single-host",level:3},{value:"Multi-Host",id:"multi-host",level:3},{value:"How a Request Flows",id:"how-a-request-flows",level:2},{value:"What It Can Do Today",id:"what-it-can-do-today",level:2},{value:"Health Checks",id:"health-checks",level:2},{value:"Distributed Tracing",id:"distributed-tracing",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"Enabling Tracing",id:"enabling-tracing",level:3},{value:"Debugging with Traces",id:"debugging-with-traces",level:3},{value:"Security",id:"security",level:2},{value:"Further Reading",id:"further-reading",level:2}];function c(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.header,{children:(0,t.jsx)(r.h1,{id:"architecture",children:"Architecture"})}),"\n",(0,t.jsx)(r.p,{children:"OSAPI turns Linux servers into managed appliances. You install a single binary,\npoint it at a config file, and get a REST API and CLI for querying and changing\nsystem configuration \u2014 hostname, DNS, disk usage, memory, load averages, and\nmore. State-changing operations run asynchronously through a job queue so the\nAPI server itself never needs root privileges."}),"\n",(0,t.jsx)(r.h2,{id:"the-three-processes",children:"The Three Processes"}),"\n",(0,t.jsx)(r.p,{children:"OSAPI has three runtime components. They can all run on the same host or be\nspread across many."}),"\n",(0,t.jsx)(r.h3,{id:"nats-server",children:"NATS Server"}),"\n",(0,t.jsxs)(r.p,{children:["A lightweight message broker that stores job state and routes messages between\nthe API server and workers. OSAPI embeds a NATS server with JetStream enabled,\nso you don't need to install anything extra \u2014 just run\n",(0,t.jsx)(r.code,{children:"osapi nats server start"}),"."]}),"\n",(0,t.jsxs)(r.p,{children:["For production deployments with multiple hosts, you can point everything at an\nexternal NATS cluster instead of the embedded one. Just change the ",(0,t.jsx)(r.code,{children:"nats.server"}),"\nsection in ",(0,t.jsx)(r.code,{children:"osapi.yaml"}),"."]}),"\n",(0,t.jsx)(r.h3,{id:"api-server",children:"API Server"}),"\n",(0,t.jsx)(r.p,{children:"An HTTP server that exposes a REST API. It handles authentication (JWT),\nvalidates requests, and translates them into jobs that get published to NATS.\nThe API server never executes system commands directly \u2014 it creates a job and\nreturns a job ID. Clients poll for results."}),"\n",(0,t.jsxs)(r.p,{children:["Start it with ",(0,t.jsx)(r.code,{children:"osapi api server start"}),"."]}),"\n",(0,t.jsx)(r.h3,{id:"worker",children:"Worker"}),"\n",(0,t.jsx)(r.p,{children:"A background process that subscribes to NATS, picks up jobs, and executes the\nactual system operations (reading hostname, querying DNS, checking disk usage,\netc.). Workers run with whatever privileges they have \u2014 if a worker can't read\nsomething due to permissions, it reports the error rather than failing silently."}),"\n",(0,t.jsxs)(r.p,{children:["Start it with ",(0,t.jsx)(r.code,{children:"osapi job worker start"}),"."]}),"\n",(0,t.jsx)(r.h2,{id:"deployment-models",children:"Deployment Models"}),"\n",(0,t.jsx)(r.h3,{id:"single-host",children:"Single Host"}),"\n",(0,t.jsx)(r.p,{children:"The simplest setup. All three processes run on the same machine:"}),"\n",(0,t.jsx)(r.mermaid,{value:'graph TD\n    subgraph host["Linux Host"]\n        CLI["CLI"]\n        API["API Server"]\n        Worker["Worker"]\n        NATS["NATS (embedded)"]\n\n        CLI --\x3e|HTTP| API\n        API --\x3e|publish job| NATS\n        NATS --\x3e|deliver job| Worker\n        Worker --\x3e|write result| NATS\n        API --\x3e|read result| NATS\n    end'}),"\n",(0,t.jsx)(r.p,{children:"The CLI on the same host talks to the API server over localhost. This is useful\nfor managing a single appliance or for development."}),"\n",(0,t.jsx)(r.h3,{id:"multi-host",children:"Multi-Host"}),"\n",(0,t.jsx)(r.p,{children:"For managing a fleet, run a shared NATS server (or cluster) and point multiple\nworkers at it. Each worker registers with its hostname and optional labels, and\nthe job routing system delivers work to the right place."}),"\n",(0,t.jsx)(r.mermaid,{value:'graph TD\n    CLI["CLI"]\n    API["API Server"]\n    NATS["NATS (shared)"]\n    W1["Worker (web-01)"]\n    W2["Worker (web-02)"]\n\n    CLI --\x3e|HTTP| API\n    API --\x3e|publish job| NATS\n    NATS --\x3e|deliver job| W1\n    NATS --\x3e|deliver job| W2\n    W1 --\x3e|write result| NATS\n    W2 --\x3e|write result| NATS\n    API --\x3e|read result| NATS'}),"\n",(0,t.jsx)(r.p,{children:"You can target jobs to specific hosts, broadcast to all, or route by label:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"--target _any"})," \u2014 send to any available worker (load balanced)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"--target _all"})," \u2014 send to every worker (broadcast)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"--target web-01"})," \u2014 send to a specific host"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"--target group:web.dev"})," \u2014 send to all workers with a matching label"]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"how-a-request-flows",children:"How a Request Flows"}),"\n",(0,t.jsxs)(r.p,{children:["When you run a command like ",(0,t.jsx)(r.code,{children:"osapi client system hostname"}),":"]}),"\n",(0,t.jsx)(r.mermaid,{value:"sequenceDiagram\n    participant CLI\n    participant API as API Server\n    participant NATS\n    participant Worker\n\n    CLI->>API: POST /api/v1/jobs\n    API->>NATS: store job in KV\n    API->>NATS: publish notification\n    API--\x3e>CLI: 201 (job_id)\n    NATS->>Worker: deliver notification\n    Worker->>NATS: read job from KV\n    Worker->>Worker: execute operation\n    Worker->>NATS: write result to KV\n    CLI->>API: GET /api/v1/jobs/{id}\n    API->>NATS: read result from KV\n    API--\x3e>CLI: 200 (result)"}),"\n",(0,t.jsx)(r.p,{children:"The API server never touches the operating system directly. It's a thin\ncoordination layer between clients and workers."}),"\n",(0,t.jsx)(r.h2,{id:"what-it-can-do-today",children:"What It Can Do Today"}),"\n",(0,t.jsxs)(r.table,{children:[(0,t.jsx)(r.thead,{children:(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.th,{children:"Domain"}),(0,t.jsx)(r.th,{children:"Operations"})]})}),(0,t.jsxs)(r.tbody,{children:[(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"System"}),(0,t.jsx)(r.td,{children:"Hostname, uptime, OS info, disk, memory, load"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Network"}),(0,t.jsx)(r.td,{children:"DNS configuration (get/update), ping"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Jobs"}),(0,t.jsx)(r.td,{children:"Create, list, get, delete, retry, queue stats, worker list"})]}),(0,t.jsxs)(r.tr,{children:[(0,t.jsx)(r.td,{children:"Health"}),(0,t.jsx)(r.td,{children:"Liveness, readiness, system status with metrics"})]})]})]}),"\n",(0,t.jsx)(r.h2,{id:"health-checks",children:"Health Checks"}),"\n",(0,t.jsx)(r.p,{children:"The API server exposes health endpoints for load balancers and monitoring:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"/health"})," \u2014 is the process alive? (always returns 200)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"/health/ready"})," \u2014 can it serve traffic? (checks NATS and KV connectivity)"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.code,{children:"/health/status"})," \u2014 per-component status with system metrics (requires auth)"]}),"\n"]}),"\n",(0,t.jsx)(r.h2,{id:"distributed-tracing",children:"Distributed Tracing"}),"\n",(0,t.jsxs)(r.p,{children:["OSAPI uses ",(0,t.jsx)(r.a,{href:"https://opentelemetry.io/",children:"OpenTelemetry"})," to propagate a single\ntrace ID through every component in a request flow. When tracing is enabled, you\ncan follow a request from CLI to API server to worker by filtering logs on\n",(0,t.jsx)(r.code,{children:"trace_id"}),"."]}),"\n",(0,t.jsx)(r.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"CLI \u2500\u2500[traceparent HTTP header]\u2500\u2500> API Server \u2500\u2500[traceparent NATS header]\u2500\u2500> Worker\n"})}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"CLI"})," creates a root span and injects ",(0,t.jsx)(r.code,{children:"traceparent"})," into the HTTP request"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"API Server"})," continues the trace via ",(0,t.jsx)(r.code,{children:"otelecho"})," middleware, then the\nnats-client automatically injects trace context into NATS message headers\nwhen publishing job notifications"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.strong,{children:"Worker"})," extracts trace context from the NATS message headers and creates a\n",(0,t.jsx)(r.code,{children:"job.process"})," span, linking its work to the original request"]}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:["All structured log lines include ",(0,t.jsx)(r.code,{children:"trace_id"})," and ",(0,t.jsx)(r.code,{children:"span_id"})," when a span is active,\nso ",(0,t.jsx)(r.code,{children:"grep trace_id=<hex>"})," shows the complete end-to-end flow."]}),"\n",(0,t.jsx)(r.h3,{id:"enabling-tracing",children:"Enabling Tracing"}),"\n",(0,t.jsxs)(r.p,{children:["Tracing is off by default. Enable it in ",(0,t.jsx)(r.code,{children:"osapi.yaml"}),":"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:'telemetry:\n  tracing:\n    enabled: true\n    exporter: stdout # or "otlp" for production backends\n'})}),"\n",(0,t.jsxs)(r.p,{children:["The ",(0,t.jsx)(r.code,{children:"--debug"})," flag auto-enables stdout tracing with no extra configuration."]}),"\n",(0,t.jsx)(r.p,{children:"For production, use the OTLP exporter to send traces to Jaeger, Tempo, or any\nOTel-compatible backend:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-yaml",children:"telemetry:\n  tracing:\n    enabled: true\n    exporter: otlp\n    otlp_endpoint: localhost:4317\n"})}),"\n",(0,t.jsx)(r.h3,{id:"debugging-with-traces",children:"Debugging with Traces"}),"\n",(0,t.jsx)(r.p,{children:"To trace a request end-to-end:"}),"\n",(0,t.jsxs)(r.ol,{children:["\n",(0,t.jsxs)(r.li,{children:["Run all three processes with ",(0,t.jsx)(r.code,{children:"--debug"})," (or ",(0,t.jsx)(r.code,{children:"telemetry.tracing.enabled: true"}),")"]}),"\n",(0,t.jsxs)(r.li,{children:["Execute a command: ",(0,t.jsx)(r.code,{children:"osapi client system hostname"})]}),"\n",(0,t.jsxs)(r.li,{children:["Find the ",(0,t.jsx)(r.code,{children:"trace_id"})," in any component's log output"]}),"\n",(0,t.jsxs)(r.li,{children:["Filter all logs: ",(0,t.jsx)(r.code,{children:"grep trace_id=<hex>"})," across API server and worker output"]}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"Example log output showing the same trace ID across components:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"# API Server\nINF publishing job request  job_id=abc123 trace_id=e0fd287f... span_id=1a2b3c...\nINF received job response   job_id=abc123 trace_id=e0fd287f... span_id=1a2b3c...\n\n# Worker\nINF processing job          job_id=abc123 trace_id=e0fd287f... span_id=4d5e6f...\nINF job processing completed job_id=abc123 trace_id=e0fd287f... span_id=4d5e6f...\n"})}),"\n",(0,t.jsx)(r.h2,{id:"security",children:"Security"}),"\n",(0,t.jsxs)(r.p,{children:["All API endpoints (except health probes) require a JWT bearer token. Tokens\ncarry a role (",(0,t.jsx)(r.code,{children:"admin"}),", ",(0,t.jsx)(r.code,{children:"write"}),", or ",(0,t.jsx)(r.code,{children:"read"}),") that determines what the caller can\ndo. The API server validates tokens using a shared signing key."]}),"\n",(0,t.jsx)(r.h2,{id:"further-reading",children:"Further Reading"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/osapi/sidebar/architecture/system-architecture",children:"System Architecture"})," \u2014 package layout, handler\nstructure, provider pattern, and code-level details"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/osapi/sidebar/architecture/job-architecture",children:"Job Architecture"})," \u2014 KV-first design, subject routing,\nworker pipeline, and multi-host processing"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/osapi/sidebar/configuration",children:"Configuration"})," \u2014 full ",(0,t.jsx)(r.code,{children:"osapi.yaml"})," reference with every\nsupported field"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/osapi/sidebar/api-guidelines",children:"API Design Guidelines"})," \u2014 REST conventions and endpoint\npatterns"]}),"\n",(0,t.jsxs)(r.li,{children:[(0,t.jsx)(r.a,{href:"/osapi/sidebar/development",children:"Development"})," \u2014 setup, building, testing, and contributing"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},28453(e,r,n){n.d(r,{R:()=>a,x:()=>o});var t=n(96540);const s={},i=t.createContext(s);function a(e){const r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);