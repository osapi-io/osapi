---
date: 2026-02-20
---

## Summary

Implemented distributed tracing with OpenTelemetry across all OSAPI
components (CLI, API server, worker).

## Changes

- `go.mod` / `go.sum` — Added OTel SDK, exporters, otelecho middleware
- `internal/config/types.go` — Added `Telemetry` and `TracingConfig`
  structs
- `osapi.yaml` — Added `telemetry.tracing` section
- `internal/telemetry/telemetry.go` — NEW: Tracer provider
  initialization (stdout, OTLP, noop)
- `internal/telemetry/propagation.go` — NEW: KV map inject/extract for
  trace context
- `internal/telemetry/slog.go` — NEW: slog handler wrapper that adds
  trace_id/span_id
- `internal/telemetry/*_public_test.go` — NEW: 8 tests covering all
  telemetry functionality
- `internal/api/server.go` — Added `otelecho.Middleware("osapi-api")`
- `internal/client/client.go` — Inject traceparent into HTTP headers
- `internal/job/worker/consumer.go` — Copy NATS message headers from
  `jetstream.Msg` to `*nats.Msg` in `handleJobMessageJS`
- `internal/job/worker/handler.go` — Extract trace context from NATS
  message headers, create `job.process` span with attributes
- `internal/job/worker/handler_test.go` — Updated writeStatusEvent
  calls with context parameter
- `cmd/root.go` — Debug auto-enable, slog trace wrapper
- `cmd/api_server_start.go` — Init tracer provider with shutdown
- `cmd/job_worker_start.go` — Init tracer provider with shutdown
- `cmd/client.go` — Init tracer in PersistentPreRun, shutdown in
  PersistentPostRun
- `docs/docs/sidebar/configuration.md` — Documented telemetry config

## Decisions

- Initially propagated trace context through KV job data map, then
  moved to NATS message headers for cleaner separation (trace context
  is transport metadata, not business data).
- nats-client `Publish` transparently injects OTel trace context —
  callers just pass `ctx`, no manual header management needed.
- `ExtractTraceContextFromHeader` normalizes header keys before
  extraction. NATS JetStream delivers headers with non-canonical
  casing (lowercase `traceparent` instead of `Traceparent`), which
  breaks `http.Header.Get` lookups that depend on canonical MIME keys.
- Used a lightweight custom slog handler instead of the otelslog bridge
  to avoid an additional dependency and keep control over attribute
  naming.
- Auto-enable stdout tracing when `--debug` is set for zero-config
  development experience.

## Next Steps

- Remove `replace` directive in `go.mod` once nats-client with OTel
  support is published.
