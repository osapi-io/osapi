---
title: Audit and clean up mocks repo-wide
status: backlog
created: 2026-02-17
updated: 2026-02-17
---

## Objective

Do a repo-wide audit of mocks with a focus on removing unused mocks and
eliminating hand-rolled assertion-based mocks when mockgen-generated
mocks already exist. The provider packages have many hand-written mocks
in `mocks.go` files that may be unnecessary or could be replaced with
mockgen or inline test-table mocks.

## Goals

1. Find mockgen-generated mocks and hand-rolled mocks (especially under
   `*/mocks/`, provider `mocks.go` files, etc.)
2. Identify mocks that are no longer referenced anywhere and delete them
3. Ensure tests using mockgen mocks are not also using complex
   hand-rolled mocks with custom assertion logic
4. Refactor tests to use a single consistent mocking approach per
   dependency/package
5. Evaluate provider `mocks.go` files — are they necessary? Are the
   function names well-written? Can we use mockgen or inline mocks in
   test tables instead?

## What to Scan For

### A) mockgen-generated mocks
- Markers: `// Code generated by MockGen. DO NOT EDIT.`
- `mockgen` in `go:generate` directives
- Packages named `mocks` that import `gomock`

### B) Hand-rolled mocks / fakes
- Types named `*Mock*`, `Fake*`, `Stub*`, `Recorder*`
- Structs that embed `testing.T`, `*require.Assertions`,
  `*assert.Assertions`, or take `t *testing.T`
- Mocks that assert inside the mock method (calling `t.Fatalf`,
  `require.Equal`, `assert.Equal` inside `Foo(...)`)
- Mocks that store "expected calls" and do manual matching

## Rules

- If mockgen mocks exist for a dependency, prefer them
- Do not keep assertion-based mocks that perform checks inside the
  mock implementation
- Avoid complicated manual call-recording frameworks
- Prefer clear mock expectations in test setup + normal assertions on
  outputs
- Do not introduce custom assertion helpers

## Deliverables

1. **Inventory report**: Directory -> mock type (mockgen vs hand-rolled),
   whether referenced, recommendation (keep/refactor/delete)
2. **Cleanup**: Delete unused mock files, update imports
3. **Refactors**: Replace hand-rolled mocks with mockgen where possible,
   move expectations into test setup (gomock EXPECT chains)

## Detection Commands

```bash
# Find generated mocks
rg -n "Code generated by MockGen|mockgen" .

# Find mocks directories
find . -type d -name "mocks" -o -name "mock"

# Find hand-rolled assertion mocks
rg -n "type (Mock|Fake|Stub)" internal/

# Find import usage of mock packages
rg -n 'mocks"|/mocks' .

# After changes
go test ./...
```

## Constraints

- Maintain existing conventions: table-driven tests, suite usage,
  naming rules, file placement
- Don't chase lines with ugly mocks — prefer clean behavior-based
  tests with consistent mocking
